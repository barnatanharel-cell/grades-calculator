<!DOCTYPE html>
<html lang="he" dir="rtl" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××—×©×‘×•×Ÿ ×¦×™×•× ×™×</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { dark: { bg: '#0f172a', card: '#1e293b', text: '#f1f5f9', border: '#334155' } } } }
        }
    </script>
    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        input[type=range] { -webkit-appearance: none; width: 100%; height: 5px; border-radius: 5px; background: #e2e8f0; outline: none; }
        .dark input[type=range] { background: #334155; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: #3b82f6; cursor: pointer; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .sim-slider::-webkit-slider-thumb { background: #6366f1 !important; }
        .input-minimal { background: transparent; border-bottom: 1px solid transparent; width: 100%; padding: 4px 2px; text-align: center; outline: none; transition: all 0.2s; font-variant-numeric: tabular-nums; }
        .input-minimal:focus { border-bottom-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }
        .hidden-content { display: none; }
        .active-tab { background-color: #3b82f6 !important; color: white !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .magen-badge { white-space: nowrap; min-width: max-content; }
        .ai-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-dark-bg dark:text-dark-text min-h-screen p-4 md:p-8 font-sans">
    
    <div class="max-w-[1600px] mx-auto space-y-8">
        
        <div class="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-sm border-r-4 border-blue-600 flex flex-col xl:flex-row justify-between items-center gap-6 sticky top-0 z-50 bg-opacity-95 backdrop-blur-md">
            <div class="flex items-center gap-4 w-full xl:w-auto">
                <div class="p-3 bg-blue-50 dark:bg-blue-900/30 rounded-xl text-blue-600"><i class="fas fa-calculator text-2xl"></i></div>
                <div>
                    <h1 class="text-3xl font-black tracking-tight">××—×©×‘×•×Ÿ ×¦×™×•× ×™×</h1>
                    <button id="resetSimBtn" onclick="resetAllSimulations()" class="hidden text-[10px] font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-widest hover:underline">× ×§×” ×¡×™××•×œ×¦×™×” <i class="fas fa-undo ml-1"></i></button>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 items-center bg-indigo-50 dark:bg-slate-700/50 p-3 rounded-xl border border-indigo-100 dark:border-slate-600 w-full xl:w-auto">
                <div class="flex items-center gap-3">
                    <div class="text-right">
                        <span class="text-[10px] font-bold text-indigo-500 uppercase block">×™×¢×“ ×××•×¦×¢</span>
                        <input type="number" id="targetInput" placeholder="85" oninput="calculateTarget()" class="w-16 bg-white dark:bg-slate-800 border border-indigo-200 rounded px-1 text-center font-bold text-indigo-700 outline-none">
                    </div>
                    <div class="h-8 w-px bg-indigo-200"></div>
                    <div>
                        <div id="targetResult" class="text-lg font-bold text-indigo-900 dark:text-indigo-200 leading-none">---</div>
                        <div class="text-[10px] text-indigo-400">× ×“×¨×© ×‘××‘×—× ×™×</div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-6">
                <button onclick="toggleTheme()" class="p-3 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-yellow-400 hover:scale-110 transition"><i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:inline"></i></button>
                <div class="text-right">
                    <div class="text-xs text-slate-400 font-bold uppercase">×××•×¦×¢ ×›×•×œ×œ</div>
                    <div id="totalAverage" class="text-5xl font-black text-blue-600 leading-none">00.00</div>
                    <div class="text-xs text-slate-400 mt-1">×¡×”"×› × ×§"×–: <span id="totalCredits">0</span></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 items-start">
            <div class="xl:col-span-7 space-y-8">
                <div id="semesterWrapper" class="space-y-6"></div>
                <button onclick="startNewSemester()" class="w-full py-4 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl text-slate-500 font-bold hover:bg-slate-50 transition flex items-center justify-center gap-2"><i class="fas fa-plus"></i> ×¡××¡×˜×¨ ×—×“×©</button>
            </div>

            <div class="xl:col-span-5 space-y-6 sticky top-28">
                <div class="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border">
                    <div class="flex flex-col gap-4 mb-4">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 text-sm flex items-center"><i class="fas fa-chart-pie text-purple-500 ml-2"></i>× ×™×ª×•×— × ×ª×•× ×™×</h3>
                            <div class="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1 gap-1">
                                <button onclick="setChartType('bar')" id="btn-bar" class="text-xs px-3 py-1 rounded-md transition active-tab"><i class="fas fa-chart-bar"></i></button>
                                <button onclick="setChartType('line')" id="btn-line" class="text-xs px-3 py-1 rounded-md transition hover:bg-white dark:hover:bg-slate-700"><i class="fas fa-chart-line"></i></button>
                                <button onclick="setChartType('ai')" id="btn-ai" class="text-xs px-3 py-1 rounded-md transition hover:bg-white text-purple-500 font-bold"><i class="fas fa-robot"></i></button>
                            </div>
                        </div>
                        <div id="filterContainer">
                            <select id="scopeFilter" onchange="calculateAll()" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-300 text-xs rounded-lg p-2 outline-none">
                                <option value="all">×›×œ ×”×ª×•××¨</option>
                            </select>
                        </div>
                    </div>
                    <div class="h-72 relative">
                        <canvas id="gradeChart"></canvas>
                        <div id="aiAdvisorContent" class="absolute inset-0 hidden overflow-y-auto bg-slate-50 dark:bg-slate-900 rounded-xl p-4 space-y-4">
                            <div class="flex items-start gap-3">
                                <div class="bg-purple-600 text-white p-2 rounded-lg ai-pulse"><i class="fas fa-brain"></i></div>
                                <div class="flex-1">
                                    <p class="text-sm font-bold text-purple-600 mb-1">××” ×¢×“×™×£ ×œ×™ ×œ×’×©×ª?</p>
                                    <div id="aiTextOutput" class="text-xs text-slate-600 dark:text-slate-300 leading-relaxed"></div>
                                </div>
                            </div>
                            <div id="retakeList" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-dark-card rounded-2xl shadow-lg border border-slate-200 dark:border-dark-border overflow-hidden flex flex-col max-h-[50vh]">
                    <div class="p-4 bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="font-bold text-slate-700 dark:text-slate-200 text-sm">×¢×¨×™×›×ª × ×ª×•× ×™×</h2>
                        <div class="flex gap-2">
                            <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">
                            <button onclick="exportData()" class="text-slate-400 hover:text-blue-500 text-xs"><i class="fas fa-download"></i></button>
                            <button onclick="triggerImport()" class="text-slate-400 hover:text-blue-500 text-xs"><i class="fas fa-upload"></i></button>
                            <button onclick="resetDefaults()" class="text-slate-400 hover:text-red-500 text-xs"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="overflow-auto custom-scrollbar p-1">
                        <table class="w-full text-[11px] border-collapse">
                            <thead class="text-[9px] text-slate-400 uppercase sticky top-0 bg-white dark:bg-dark-card z-10">
                                <tr><th class="p-2 text-right">×§×•×¨×¡</th><th class="p-1">×‘×™× ××¨×™</th><th class="p-1">×¡×'</th><th class="p-1">× ×§"×–</th><th class="p-1 text-blue-500">×¢×‘'</th><th class="p-1 text-blue-500">×‘×—×Ÿ</th><th class="p-1 text-orange-500">%×¢</th><th class="p-1 text-orange-500">%×‘</th><th class="p-1"></th></tr>
                            </thead>
                            <tbody id="settingsTableBody" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                    <div class="p-3 bg-slate-50 dark:bg-slate-800">
                        <button onclick="addNewCourse()" class="w-full py-2 bg-white dark:bg-slate-700 border border-slate-200 text-blue-600 font-bold rounded-xl text-xs"><i class="fas fa-plus"></i> ×”×•×¡×£ ×§×•×¨×¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="subCalcModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white dark:bg-dark-card w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-pop">
            <div class="p-4 bg-blue-600 text-white flex justify-between items-center"><h3 class="font-bold flex items-center gap-2"><i class="fas fa-calculator"></i> ××—×©×‘×•×Ÿ ××©× ×”</h3><button onclick="closeSubCalc()" class="text-white hover:text-slate-200"><i class="fas fa-times"></i></button></div>
            <div class="p-4 space-y-3 max-h-[50vh] overflow-y-auto" id="modalRows"></div>
            <div class="p-4 bg-slate-50 dark:bg-slate-800 space-y-3">
                <div class="flex justify-between text-xs font-bold"><span class="text-slate-500">××©×§×œ ×‘×§×•×¨×¡:</span><span id="modalTotalWeight" class="text-orange-500">0%</span></div>
                <div class="flex justify-between text-lg font-black"><span class="text-slate-700 dark:text-slate-200">×¦×™×•×Ÿ ××©×•×§×œ×œ:</span><span id="modalFinalGrade" class="text-blue-600">0</span></div>
                <div class="grid grid-cols-2 gap-3"><button onclick="addSubCalcRow()" class="py-2 border border-blue-600 text-blue-600 rounded-xl font-bold text-xs">×”×•×¡×£ ××˜×œ×”</button><button onclick="applySubCalc()" class="py-2 bg-blue-600 text-white rounded-xl font-bold text-xs">×¢×“×›×Ÿ</button></div>
            </div>
        </div>
    </div>

    <script>
        // --- Core Data ---
        const defaultData = [
            { id: 'calc', name: '×—×“×•"× 1', semester: 1, credits: 5, work: 100, quiz: 87, weights: { work: 10, quiz: 15 }, exam: 60, workMagen: false, quizMagen: true, isBinary: false, simExam: null },
            { id: 'discrete', name: '×“×™×¡×§×¨×˜×™×ª', semester: 1, credits: 3, work: 100, quiz: 78, weights: { work: 8, quiz: 7 }, exam: 60, workMagen: true, quizMagen: false, isBinary: false, simExam: null },
            { id: 'linear', name: '×œ×™× ××¨×™×ª', semester: 1, credits: 3.5, work: 100, quiz: 90, weights: { work: 15, quiz: 15 }, exam: 60, isBinary: false, simExam: null },
            { id: 'physics', name: '×¤×™×–×™×§×”', semester: 1, credits: 3.5, work: 100, quiz: 60, weights: { work: 15, quiz: 15 }, exam: 60, quizMagen: true, isBinary: false, simExam: null },
            { id: 'sport', name: '×¡×¤×•×¨×˜', semester: 1, credits: 1, work: 0, quiz: 0, weights: { work: 0, quiz: 0 }, exam: 0, isBinary: true, simExam: null }, 
        ];
        let courses = JSON.parse(localStorage.getItem('harelGradesV11_2')) || JSON.parse(JSON.stringify(defaultData));
        courses.forEach(c => { if(c.simExam === undefined) c.simExam = null; });

        let collapsedSemesters = {}; let chart = null; let currentChartType = 'bar'; let activeCalcContext = null;

        function init() {
            if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            const maxSem = courses.length > 0 ? Math.max(...courses.map(c => c.semester)) : 1;
            [...new Set(courses.map(c => c.semester))].forEach(s => { if (s < maxSem) collapsedSemesters[s] = true; });
            updateFilterOptions(); renderAll(); calculateAll();
        }

        // --- Core Calc Logic ---
        function calculateCourseFinal(c, useSim = true) {
            if (c.isBinary) return "×¢×•×‘×¨"; 
            let wp = parseFloat(c.weights.work) || 0, qp = parseFloat(c.weights.quiz) || 0;
            const w = parseFloat(c.work) || 0, q = parseFloat(c.quiz) || 0;
            const ex = (useSim && c.simExam !== null) ? parseFloat(c.simExam) : parseFloat(c.exam) || 0;
            if (c.workMagen && w < ex) wp = 0;
            if (c.quizMagen && q < ex) qp = 0;
            return (((w * wp) + (q * qp) + (ex * (100 - wp - qp))) / 100).toFixed(2);
        }

        function calculateAll() {
            let twSim = 0, tgc = 0, tca = 0, semStats = {};
            let labels = [], data = [], colors = [], distro = { '90+': 0, '80-89': 0, '70-79': 0, '60-69': 0, '0-59': 0 };
            let isSimActive = false;

            courses.forEach(c => {
                const cr = parseFloat(c.credits) || 0; tca += cr;
                if (!semStats[c.semester]) semStats[c.semester] = { sum: 0, creds: 0 };
                if (c.isBinary) return; 
                const finalSim = parseFloat(calculateCourseFinal(c, true));
                if(c.simExam !== null) isSimActive = true;
                twSim += finalSim * cr; tgc += cr;
                semStats[c.semester].sum += finalSim * cr; semStats[c.semester].creds += cr;

                if (shouldShowInChart(c)) {
                    labels.push(c.name); data.push(finalSim); colors.push(getBarColor(finalSim));
                    if (finalSim >= 90) distro['90+']++; else if (finalSim >= 80) distro['80-89']++; else if (finalSim >= 70) distro['70-79']++; else if (finalSim >= 60) distro['60-69']++; else distro['0-59']++;
                }
            });

            document.getElementById('totalAverage').innerText = tgc > 0 ? (twSim / tgc).toFixed(2) : "0.00";
            document.getElementById('totalCredits').innerText = tca;
            document.getElementById('resetSimBtn').classList.toggle('hidden', !isSimActive);
            for (const [s, st] of Object.entries(semStats)) {
                const el = document.getElementById(`semAvg_${s}`); if (el) el.innerText = st.creds > 0 ? (st.sum / st.creds).toFixed(2) : "0.00";
            }
            calculateTarget();
            if (currentChartType === 'ai') updateAIAdvisor(); else updateChart(labels, data, colors, tgc > 0 ? (twSim / tgc).toFixed(2) : 0, semStats, distro);
        }

        // --- AI Advisor (ROI Analysis) ---
        function updateAIAdvisor() {
            const out = document.getElementById('aiTextOutput'), list = document.getElementById('retakeList'), totalCr = courses.reduce((s, c) => s + (c.isBinary ? 0 : parseFloat(c.credits) || 0), 0);
            if (totalCr === 0) { out.innerText = "×”×–×Ÿ ×¦×™×•× ×™× ×›×“×™ ×œ×§×‘×œ ×”××œ×¦×•×ª."; return; }
            let insights = courses.filter(c => !c.isBinary).map(c => {
                const cur = parseFloat(calculateCourseFinal(c, true));
                const weight = (parseFloat(c.credits) || 0) / totalCr;
                return { name: c.name, gain: (100 - cur) * weight, weight, isSim: c.simExam !== null };
            });
            insights.sort((a, b) => b.gain - a.gain);
            out.innerHTML = `×”× ×” ×”×§×•×¨×¡×™× ×©×©×™×¤×•×¨ ×‘×”× ×™×™×ª×Ÿ ×œ×š ××ª ×”××§×¡×™××•× ×œ×××•×¦×¢ ${insights.some(i=>i.isSim)?'(×œ×¤×™ ×”×¡×™××•×œ×¦×™×”)':''}:`;
            list.innerHTML = '';
            insights.slice(0, 3).forEach((ins, i) => {
                if (ins.gain <= 0.01) return;
                const cols = ['purple', 'blue', 'indigo'];
                list.innerHTML += `<div class="bg-white dark:bg-slate-800 p-2 rounded border-r-4 border-${cols[i]}-500 shadow-sm"><div class="flex justify-between font-bold text-[10px]"><span>${ins.name} ${ins.isSim?'(×¡×™××•×œ×¦×™×”)':''}</span><span class="text-green-500">+${ins.gain.toFixed(2)} ×œ×××•×¦×¢</span></div><p class="text-[9px] text-slate-400">×›×œ 10 × ×§×•×“×•×ª ×©×ª×©×¤×¨ ×¤×” ×©×•×•×ª ${(ins.weight*10).toFixed(2)} ×œ×××•×¦×¢ ×”×›×œ×œ×™.</p></div>`;
            });
        }

        // --- UI Interactions ---
        function updateSim(i, val) {
            courses[i].simExam = val === "" ? null : parseFloat(val);
            const fin = calculateCourseFinal(courses[i], true), real = calculateCourseFinal(courses[i], false);
            document.getElementById(`simVal_${i}`).innerText = val || '--';
            const fe = document.getElementById(`final_${i}`); if(fe){ fe.innerText = fin; fe.className = `text-3xl font-black ${finalColor(fin)}`; }
            const diff = (parseFloat(fin) - parseFloat(real)).toFixed(1);
            document.getElementById(`simDiff_${i}`).innerHTML = courses[i].simExam !== null ? `<span class="text-[10px] ${diff>=0?'text-green-500':'text-red-400'} font-bold">${diff>=0?'+':''}${diff}</span>` : '';
            calculateAll();
        }
        function resetAllSimulations() { courses.forEach(c => c.simExam = null); renderAll(); calculateAll(); }
        function updateData(i, f, v, sf = null) {
            const of = parseFloat(calculateCourseFinal(courses[i], false));
            if (f === 'isBinary') courses[i].isBinary = !courses[i].isBinary; 
            else if (f === 'weights' && sf) courses[i].weights[sf] = parseFloat(v) || 0;
            else if (f === 'name') courses[i].name = v;
            else courses[i][f] = (f === 'semester') ? parseInt(v)||1 : parseFloat(v)||0;
            saveData(); if (f === 'semester') updateFilterOptions();
            const nf = parseFloat(calculateCourseFinal(courses[i], false));
            if (nf >= 100 && of < 100) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            if (['semester', 'name', 'credits', 'isBinary'].includes(f)) renderAll(); else refreshSingleCard(i);
            calculateAll();
        }
        function toggleMagen(i, t) { if (t === 'work') courses[i].workMagen = !courses[i].workMagen; else courses[i].quizMagen = !courses[i].quizMagen; saveData(); calculateAll(); renderAll(); }
        function setChartType(t) { currentChartType = t; ['bar', 'line', 'ai'].forEach(id => { const b = document.getElementById(`btn-${id}`); b.classList.toggle('active-tab', id === t); if(id!==t) b.classList.add('hover:bg-white', 'dark:hover:bg-slate-700'); else b.classList.remove('hover:bg-white', 'dark:hover:bg-slate-700'); }); document.getElementById('gradeChart').style.display = t === 'ai' ? 'none' : 'block'; document.getElementById('aiAdvisorContent').classList.toggle('hidden', t !== 'ai'); document.getElementById('filterContainer').style.visibility = t === 'ai' ? 'hidden' : 'visible'; if (chart) { chart.destroy(); chart = null; } calculateAll(); }
        function toggleTheme() { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); calculateAll(); }

        // --- Chart Engine ---
        function updateChart(labels, data, colors, avg, semStats, distro) {
            const ctx = document.getElementById('gradeChart').getContext('2d'), isD = document.documentElement.classList.contains('dark'), txt = isD ? '#cbd5e1' : '#64748b', grd = isD ? '#334155' : '#f1f5f9';
            if (chart && chart.config.type !== (currentChartType === 'bar' ? 'bar' : 'line')) { chart.destroy(); chart = null; }
            if (currentChartType === 'bar') {
                if (!chart) chart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: '×¦×™×•×Ÿ', data, backgroundColor: colors, borderRadius: 4, order: 2 }, { label: '×××•×¦×¢', data: new Array(data.length).fill(parseFloat(avg)), borderColor: '#a855f7', borderWidth: 2, borderDash: [5,5], pointRadius: 0, type: 'line', order: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, grid: { color: grd }, ticks: { color: txt } }, x: { ticks: { color: txt, maxRotation: 45, font: { size: 9 } } } }, plugins: { legend: { display: false } } } });
                else { chart.data.labels = labels; chart.data.datasets[0].data = data; chart.data.datasets[0].backgroundColor = colors; chart.data.datasets[1].data = new Array(data.length).fill(parseFloat(avg)); chart.update('none'); }
            } else if (currentChartType === 'line') {
                const sl = Object.keys(semStats).sort((a,b)=>a-b).map(s => `×¡×' ${s}`), sd = Object.keys(semStats).sort((a,b)=>a-b).map(s => (semStats[s].creds>0 ? semStats[s].sum/semStats[s].creds : 0).toFixed(2));
                if (!chart) chart = new Chart(ctx, { type: 'line', data: { labels: sl, datasets: [{ label: '×××•×¦×¢', data: sd, borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { color: txt } }, x: { ticks: { color: txt } } }, plugins: { legend: { display: false } } } });
                else { chart.data.labels = sl; chart.data.datasets[0].data = sd; chart.update('none'); }
            }
        }

        // --- Sub-Calc Modal ---
        function openSubCalc(i, t) { activeCalcContext = { index: i, type: t }; document.getElementById('modalTitle').innerText = `${courses[i].name} (${t === 'work' ? '×¢×‘×•×“×•×ª' : '×‘×—× ×™×'})`; document.getElementById('modalRows').innerHTML = ''; addSubCalcRow(); addSubCalcRow(); document.getElementById('subCalcModal').classList.remove('hidden'); updateModalResults(); }
        function closeSubCalc() { document.getElementById('subCalcModal').classList.add('hidden'); }
        function addSubCalcRow() { const d = document.createElement('div'); d.className = "grid grid-cols-12 gap-2 items-center mb-2 subcalc-row"; d.innerHTML = `<div class="col-span-7"><input type="number" placeholder="×¦×™×•×Ÿ" oninput="updateModalResults()" class="sub-grade w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-center text-sm outline-none"></div><div class="col-span-4"><input type="number" placeholder="% ××©×§×œ" oninput="updateModalResults()" class="sub-weight w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-center text-sm outline-none"></div><div class="col-span-1 text-center"><button onclick="this.parentElement.parentElement.remove(); updateModalResults();" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button></div>`; document.getElementById('modalRows').appendChild(d); }
        function updateModalResults() { let tw = 0, ws = 0; document.querySelectorAll('.subcalc-row').forEach(r => { const g = parseFloat(r.querySelector('.sub-grade').value)||0, w = parseFloat(r.querySelector('.sub-weight').value)||0; if(w>0){tw+=w; ws+=(g*w);} }); document.getElementById('modalTotalWeight').innerText = tw.toFixed(1) + '%'; document.getElementById('modalFinalGrade').innerText = tw > 0 ? (ws/tw).toFixed(2) : "0"; }
        function applySubCalc() { if (!activeCalcContext) return; let tw = 0, ws = 0; document.querySelectorAll('.subcalc-row').forEach(r => { const g = parseFloat(r.querySelector('.sub-grade').value)||0, w = parseFloat(r.querySelector('.sub-weight').value)||0; if(w>0){tw+=w; ws+=(g*w);} }); const { index, type } = activeCalcContext; if (type === 'work') { courses[index].work = (ws/tw)||0; courses[index].weights.work = tw; } else { courses[index].quiz = (ws/tw)||0; courses[index].weights.quiz = tw; } saveData(); renderAll(); calculateAll(); closeSubCalc(); }

        // --- Helpers & Storage ---
        function getBarColor(g) { const n = parseFloat(g); return n >= 90 ? '#10b981' : (n >= 80 ? '#3b82f6' : (n >= 60 ? '#eab308' : '#ef4444')); }
        function finalColor(g) { const n = parseFloat(g); return n >= 90 ? 'text-emerald-500' : (n >= 80 ? 'text-blue-600' : (n >= 60 ? 'text-yellow-500' : 'text-red-500')); }
        function saveData() { localStorage.setItem('harelGradesV11_2', JSON.stringify(courses)); }
        function updateFilterOptions() { const s=document.getElementById('scopeFilter'), ms=courses.length>0?Math.max(...courses.map(c=>c.semester)):1; let h='<option value="all">×›×œ ×”×ª×•××¨</option>'; for(let i=1;i<=Math.ceil(ms/2);i++)h+=`<option value="year_${i}">×©× ×” ${['×','×‘','×’','×“'][i-1]||i}</option>`; h+=`<option value="sem_${ms}">×¡××¡×˜×¨ ××—×¨×•×Ÿ (${ms})</option>`; s.innerHTML=h; }
        function shouldShowInChart(c) { const f=document.getElementById('scopeFilter').value; if(f==='all')return true; if(f.startsWith('sem_'))return c.semester===parseInt(f.split('_')[1]); if(f.startsWith('year_')){const y=parseInt(f.split('_')[1]); return c.semester>=y*2-1 && c.semester<=y*2;} return true; }
        function calculateTarget() { const t = parseFloat(document.getElementById('targetInput').value); const res = document.getElementById('targetResult'); if(!t){res.innerText="---"; return;} let tc=0, cp=0, tewc=0; courses.forEach(c=>{ if(c.isBinary) return; const cr=parseFloat(c.credits)||0; tc+=cr; const ew=Math.max(0, 100-(c.weights.work||0)-(c.weights.quiz||0)); cp+=((c.work||0)*(c.weights.work||0)/100+(c.quiz||0)*(c.weights.quiz||0)/100)*cr; tewc+=cr*(ew/100); }); if(tc===0||tewc<=0)return; const n=Math.ceil(((t*tc)-cp)/tewc); res.innerHTML=n>100?`<span class="text-red-500">${n} ğŸ˜±</span>`:(n<0?`<span class="text-green-500">×¢×‘×¨×ª!</span>`:n); }
        function startNewSemester() { const ms = courses.length > 0 ? Math.max(...courses.map(c => c.semester)) : 0; courses.push({ id: Date.now(), name: '×§×•×¨×¡ ×—×“×©', semester: ms+1, credits: 3, work: 100, quiz: 0, weights: { work: 10, quiz: 0 }, exam: 60, isBinary: false, simExam: null }); saveData(); updateFilterOptions(); renderAll(); calculateAll(); }
        function addNewCourse() { const ms = courses.length > 0 ? Math.max(...courses.map(c => c.semester)) : 1; courses.push({ id: Date.now(), name: '×§×•×¨×¡ ×—×“×©', semester: ms, credits: 3, work: 100, quiz: 0, weights: { work: 10, quiz: 0 }, exam: 60, isBinary: false, simExam: null }); saveData(); updateFilterOptions(); renderAll(); calculateAll(); }
        function removeCourse(i) { if(confirm("×œ××—×•×§?")) { courses.splice(i,1); saveData(); renderAll(); calculateAll(); } }
        function resetDefaults() { if(confirm("×œ××¤×¡?")) { courses = JSON.parse(JSON.stringify(defaultData)); saveData(); renderAll(); calculateAll(); } }
        function exportData() { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(courses,null,2)],{type:"application/json"})); a.download=`Grades.json`; a.click(); }
        function triggerImport() { document.getElementById('importFile').click(); }
        function importData(i) { const f=i.files[0]; if(!f)return; const r = new FileReader(); r.onload=e=>{ try{const d=JSON.parse(e.target.result); if(Array.isArray(d)){courses=d; saveData(); renderAll(); calculateAll();}}catch(err){alert('×©×’×™××”')} }; r.readAsText(f); }
        function refreshSingleCard(i) { const c = courses[i]; if(c.isBinary) return; const f = calculateCourseFinal(c, true); const fe = document.getElementById(`final_${i}`); if(fe) { fe.innerText = f; fe.className = `text-3xl font-black ${finalColor(f)}`; } }

        function renderAll() {
            const w = document.getElementById('semesterWrapper'); w.innerHTML = '';
            const sems = [...new Set(courses.map(c => c.semester))].sort((a,b) => a-b);
            sems.forEach(s => {
                w.innerHTML += `<div class="bg-white dark:bg-dark-card rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border overflow-hidden"><div class="p-4 bg-slate-50 dark:bg-slate-800/50 flex items-center justify-between cursor-pointer" onclick="document.getElementById('semContainer_${s}').classList.toggle('hidden-content'); document.getElementById('semIcon_${s}').classList.toggle('rotate-180')"><div class="flex items-center gap-3"><i id="semIcon_${s}" class="fas fa-chevron-down text-slate-400 transition-transform"></i><h2 class="text-lg font-black text-slate-700 dark:text-slate-200">×¡××¡×˜×¨ ${s}</h2></div><div class="bg-white dark:bg-slate-700 px-3 py-1 rounded-full border border-slate-200 shadow-sm"><span id="semAvg_${s}" class="text-lg font-bold text-blue-600">0.00</span></div></div><div id="semContainer_${s}" class="p-4 space-y-4 border-t border-slate-100 dark:border-slate-700/50"></div></div>`;
                courses.forEach((c, i) => {
                    if (c.semester !== s) return;
                    const final = calculateCourseFinal(c, true); const isS = c.simExam !== null; let bdg = '';
                    if (!c.isBinary && (c.workMagen || c.quizMagen)) {
                        const ex = isS ? c.simExam : c.exam;
                        if (c.workMagen) bdg += `<span class="magen-badge text-[8px] ${parseFloat(c.work)<parseFloat(ex)?'bg-slate-100 text-slate-500':'bg-green-100 text-green-600'} px-1.5 py-0.5 rounded border border-slate-200 ml-1">×¢×‘' ${parseFloat(c.work)<parseFloat(ex)?'ğŸ›¡ï¸ ×”×•×©××˜':'âœ… × ×—×©×‘'}</span>`;
                        if (c.quizMagen) bdg += `<span class="magen-badge text-[8px] ${parseFloat(c.quiz)<parseFloat(ex)?'bg-slate-100 text-slate-500':'bg-green-100 text-green-600'} px-1.5 py-0.5 rounded border border-slate-200 ml-1">×‘×—×Ÿ ${parseFloat(c.quiz)<parseFloat(ex)?'ğŸ›¡ï¸ ×”×•×©××˜':'âœ… × ×—×©×‘'}</span>`;
                    }
                    document.getElementById(`semContainer_${s}`).innerHTML += `<div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-dark-border hover:border-blue-300 transition-colors group"><div class="flex flex-col sm:flex-row items-center gap-4"><div class="flex-1 w-full"><div class="flex justify-between items-center mb-2"><div class="flex items-center flex-wrap gap-1"><h3 class="font-bold text-slate-700 dark:text-slate-200 text-lg">${c.name}</h3>${bdg}</div><span class="text-[10px] text-slate-500 bg-slate-100 dark:bg-slate-900 px-2 py-1 rounded">${c.credits} × ×§"×–</span></div>${c.isBinary ? '<div class="text-green-500 font-bold text-xl"><i class="fas fa-check-circle"></i> ×¢×•×‘×¨</div>' : `<div class="space-y-3"><div class="flex items-center gap-3"><div class="w-10 text-center"><span class="text-sm font-bold text-blue-600">${c.exam}</span><p class="text-[8px] text-slate-400">×××ª</p></div><div class="flex-1 pt-1"><input type="range" value="${c.exam}" oninput="updateData(${i},'exam',this.value)" class="accent-blue-600"></div></div><div class="flex items-center gap-3 bg-indigo-50/50 dark:bg-indigo-900/10 p-2 rounded-lg"><div class="w-10 text-center"><span class="text-sm font-bold text-indigo-600" id="simVal_${i}">${isS?c.simExam:'--'}</span><p class="text-[8px] text-indigo-400 font-bold">××” ××?</p></div><div class="flex-1 pt-1"><input type="range" value="${isS?c.simExam:c.exam}" oninput="updateSim(${i},this.value)" class="accent-indigo-600 sim-slider"></div><button onclick="updateSim(${i},'')" class="text-[10px] text-slate-300 hover:text-red-400"><i class="fas fa-times-circle"></i></button></div></div>`}</div>${c.isBinary?'':`<div class="text-center w-full sm:w-24 sm:pl-4 sm:border-r border-slate-100 dark:border-slate-700"><div class="text-[10px] text-slate-400 font-bold uppercase">×¡×•×¤×™</div><div id="final_${i}" class="text-3xl font-black ${finalColor(final)}">${final}</div><div id="simDiff_${i}"></div></div>`}</div></div>`;
                });
            });
            renderTable();
        }

        function renderTable() {
            const tb = document.getElementById('settingsTableBody'); tb.innerHTML = '';
            const sems = [...new Set(courses.map(c => c.semester))].sort((a,b) => a-b);
            sems.forEach(s => {
                const isc = collapsedSemesters[s];
                tb.innerHTML += `<tr class="bg-slate-100 dark:bg-slate-700 cursor-pointer font-bold" onclick="collapsedSemesters[${s}]=!collapsedSemesters[${s}]; renderTable();"><td colspan="9" class="p-1.5 pr-4 text-xs"><i class="fas fa-chevron-up text-[8px] transition-transform ${isc?'rotate-180':''}"></i> ×¡××¡×˜×¨ ${s}</td></tr>`;
                if (!isc) {
                    courses.forEach((c, i) => {
                        if (c.semester !== s) return;
                        const bin = c.isBinary;
                        tb.innerHTML += `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors border-b border-slate-100 dark:border-slate-700"><td class="p-1"><input type="text" value="${c.name}" onchange="updateData(${i},'name',this.value)" class="input-minimal text-right w-20"></td><td class="p-1 text-center"><input type="checkbox" onchange="updateData(${i},'isBinary')" ${bin?'checked':''} class="w-3 h-3 cursor-pointer"></td><td class="p-1"><input type="number" value="${c.semester}" onchange="updateData(${i},'semester',this.value)" class="input-minimal w-10 text-center"></td><td class="p-1"><input type="number" value="${c.credits}" onchange="updateData(${i},'credits',this.value)" class="input-minimal w-10 text-center"></td><td class="p-1 ${bin?'opacity-20 pointer-events-none':''}"><div class="flex items-center gap-1 justify-center"><input type="number" value="${Math.round(c.work)}" onchange="updateData(${i},'work',this.value)" class="input-minimal text-blue-600 w-10"> <button onclick="openSubCalc(${i},'work')" class="text-[9px] text-slate-400 hover:text-blue-500"><i class="fas fa-calculator"></i></button></div></td><td class="p-1 ${bin?'opacity-20 pointer-events-none':''}"><div class="flex items-center gap-1 justify-center"><input type="number" value="${Math.round(c.quiz)}" onchange="updateData(${i},'quiz',this.value)" class="input-minimal text-blue-600 w-10"> <button onclick="openSubCalc(${i},'quiz')" class="text-[9px] text-slate-400 hover:text-blue-500"><i class="fas fa-calculator"></i></button></div></td><td class="p-1 ${bin?'opacity-20 pointer-events-none':''}"><div class="flex items-center gap-0.5 justify-center"><input type="number" value="${c.weights.work}" onchange="updateData(${i},'weights',this.value,'work')" class="input-minimal text-orange-600 w-8"> <button onclick="toggleMagen(${i},'work')" class="text-[9px] ${c.workMagen?'text-green-500':'text-slate-300'}"><i class="fas fa-shield-alt"></i></button></div></td><td class="p-1 ${bin?'opacity-20 pointer-events-none':''}"><div class="flex items-center gap-0.5 justify-center"><input type="number" value="${c.weights.quiz}" onchange="updateData(${i},'weights',this.value,'quiz')" class="input-minimal text-orange-600 w-8"> <button onclick="toggleMagen(${i},'quiz')" class="text-[9px] ${c.quizMagen?'text-green-500':'text-slate-300'}"><i class="fas fa-shield-alt"></i></button></div></td><td class="p-1 text-center"><button onclick="removeCourse(${i})" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-times"></i></button></td></tr>`;
                    });
                }
            });
        }
        init();
    </script>
</body>
</html>
