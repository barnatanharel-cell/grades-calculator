<!DOCTYPE html>
<html lang="he" dir="rtl" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××—×©×‘×•×Ÿ ×¦×™×•× ×™×</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { dark: { bg: '#0f172a', card: '#1e293b', text: '#f1f5f9', border: '#334155' } } } }
        }
    </script>
    <style>
        body { transition: background-color 0.3s, color 0.3s; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        input[type=range] { -webkit-appearance: none; width: 100%; height: 5px; border-radius: 5px; background: #e2e8f0; outline: none; }
        .dark input[type=range] { background: #334155; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: #3b82f6; cursor: pointer; border: 2px solid white; }
        .sim-slider::-webkit-slider-thumb { background: #6366f1 !important; }
        .input-minimal { background: transparent; border-bottom: 1px solid transparent; width: 100%; padding: 4px 2px; text-align: center; outline: none; transition: all 0.2s; }
        .input-minimal:focus { border-bottom-color: #3b82f6; background-color: rgba(59, 130, 246, 0.05); }
        .hidden-content { display: none; }
        .active-tab { background-color: #3b82f6 !important; color: white !important; }
        .magen-badge { white-space: nowrap; min-width: max-content; }
        .ai-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

       @media (min-width: 1280px) {
            .sticky-sidebar { 
                position: sticky; 
                top: 110px; 
                padding-left: 4px; 
            }
        }

        @media print {
            .no-print, button, input[type=range], #subCalcModal, #aiAdvisorContent, #gradeChart, #filterContainer { display: none !important; }
            body { background: white; color: black; }
            .xl\:col-span-5 { display: none; }
            .xl\:col-span-7 { width: 100%; grid-column: span 12; }
            .card-transition { break-inside: avoid; border: 1px solid #eee !important; margin-bottom: 10px; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-dark-bg dark:text-dark-text min-h-screen p-4 md:p-8 font-sans">
    
    <div class="max-w-[1600px] mx-auto space-y-8">
        
        <div class="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-sm border-r-4 border-blue-600 flex flex-col xl:flex-row justify-between items-center gap-6 sticky top-0 z-50 bg-opacity-95 backdrop-blur-md no-print">
            <div class="flex items-center gap-4 w-full xl:w-auto">
                <div class="p-3 bg-blue-50 dark:bg-blue-900/30 rounded-xl text-blue-600 no-print"><i class="fas fa-calculator text-2xl"></i></div>
                <div>
                    <h1 class="text-3xl font-black tracking-tight">××—×©×‘×•×Ÿ ×¦×™×•× ×™×</h1>
                    <button id="resetSimBtn" onclick="resetAllSimulations()" class="hidden text-[10px] font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-widest hover:underline no-print">× ×§×” ×¡×™××•×œ×¦×™×” <i class="fas fa-undo ml-1"></i></button>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 items-center bg-indigo-50 dark:bg-slate-700/50 p-3 rounded-xl border border-indigo-100 dark:border-slate-600 w-full xl:w-auto no-print">
                <div class="flex items-center gap-3">
                    <div class="text-right">
                        <span class="text-[10px] font-bold text-indigo-500 uppercase block">×™×¢×“ ×××•×¦×¢</span>
                        <input type="number" id="targetInput" placeholder="85" min="0" max="100" oninput="enforceMax(this); calculateAll()" class="w-16 bg-white dark:bg-slate-800 border border-indigo-200 rounded px-1 text-center font-bold text-indigo-700 outline-none">
                    </div>
                    <div class="h-8 w-px bg-indigo-200"></div>
                    <div>
                        <div id="targetResult" class="text-lg font-bold text-indigo-900 dark:text-indigo-200 leading-none">---</div>
                        <div class="text-[10px] text-indigo-400">× ×“×¨×© ×‘××‘×—× ×™×</div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-6">
                <button onclick="toggleTheme()" class="p-3 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-yellow-400 hover:scale-110 transition no-print"><i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:inline"></i></button>
                <div class="text-right">
                    <div class="text-xs text-slate-400 font-bold uppercase">×××•×¦×¢ ×›×•×œ×œ</div>
                    <div id="totalAverage" class="text-5xl font-black text-blue-600 leading-none">00.00</div>
                    <div class="text-xs text-slate-400 mt-1">×¡×”"×› × ×§"×–: <span id="totalCredits">0</span></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-8 items-start">
            <div class="xl:col-span-7 space-y-8">
                <div id="semesterWrapper" class="space-y-6"></div>
                <button onclick="startNewSemester()" class="w-full py-5 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl text-slate-500 font-bold hover:bg-white hover:border-blue-400 hover:text-blue-500 transition-all flex items-center justify-center gap-2 no-print"><i class="fas fa-plus-circle text-xl"></i> ×¤×ª×— ×¡××¡×˜×¨ ×—×“×©</button>
            </div>

            <div class="xl:col-span-5">
                <div class="sticky-sidebar space-y-6">
                    <div class="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border">
                        <div class="flex flex-col gap-4 mb-4">
                            <div class="flex justify-between items-center">
                                <h3 class="font-bold text-slate-700 dark:text-slate-200 text-sm flex items-center"><i class="fas fa-chart-pie text-purple-500 ml-2"></i>××¨×›×– × ×™×ª×•×—</h3>
                                <div class="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1 gap-1 no-print">
                                    <button onclick="setChartType('bar')" id="btn-bar" class="text-xs px-3 py-1 rounded-md transition active-tab"><i class="fas fa-chart-bar"></i></button>
                                    <button onclick="setChartType('line')" id="btn-line" class="text-xs px-3 py-1 rounded-md transition hover:bg-white dark:hover:bg-slate-700"><i class="fas fa-chart-line"></i></button>
                                    <button onclick="setChartType('ai')" id="btn-ai" class="text-xs px-3 py-1 rounded-md transition hover:bg-white text-purple-500 font-bold"><i class="fas fa-robot"></i></button>
                                </div>
                            </div>
                            <div id="filterContainer" class="no-print">
                                <select id="scopeFilter" onchange="calculateAll()" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-300 text-xs rounded-lg p-2 outline-none">
                                    <option value="all">×›×œ ×”×ª×•××¨</option>
                                </select>
                            </div>
                        </div>
                        <div class="h-64 relative">
                            <canvas id="gradeChart"></canvas>
                            <div id="aiAdvisorContent" class="absolute inset-0 hidden overflow-y-auto bg-slate-50 dark:bg-slate-900 rounded-xl p-4 space-y-4">
                                <div class="flex items-start gap-3">
                                    <div class="bg-purple-600 text-white p-2 rounded-lg ai-pulse"><i class="fas fa-brain"></i></div>
                                    <div class="flex-1">
                                        <p class="text-sm font-bold text-purple-600 mb-1">××” ×”×›×™ ×›×“××™ ×œ×™ ×œ×©×¤×¨</p>
                                        <div id="aiTextOutput" class="text-xs text-slate-600 dark:text-slate-300 leading-relaxed"></div>
                                    </div>
                                </div>
                                <div id="retakeList" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-dark-card rounded-2xl shadow-lg border border-slate-200 dark:border-dark-border overflow-hidden flex flex-col no-print">
                        <div class="p-4 bg-slate-50 dark:bg-slate-800 border-b border-slate-200 flex justify-between items-center">
                            <h2 class="font-bold text-slate-700 dark:text-slate-200 text-sm">×¢×¨×™×›×ª × ×ª×•× ×™×</h2>
                            <div class="flex gap-2">
                                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">
                                <button onclick="exportData()" title="×’×™×‘×•×™"><i class="fas fa-download text-slate-400"></i></button>
                                <button onclick="triggerImport()" title="×˜×¢×™× ×”"><i class="fas fa-upload text-slate-400"></i></button>
                                <button onclick="resetDefaults()" title="××™×¤×•×¡"><i class="fas fa-trash-alt text-slate-400 hover:text-red-500"></i></button>
                            </div>
                        </div>
                        <div class="overflow-x-auto p-1">
                            <table class="w-full text-[11px] border-collapse">
                                <thead class="text-[9px] text-slate-400 uppercase sticky top-0 bg-white dark:bg-dark-card z-10">
                                    <tr><th class="p-2 text-right">×§×•×¨×¡</th><th class="p-1">×‘×™× ××¨×™</th><th class="p-1">×¡×'</th><th class="p-1">× ×§"×–</th><th class="p-1">×¢×‘'</th><th class="p-1">×‘×—×Ÿ</th><th class="p-1 text-orange-500">%×¢</th><th class="p-1 text-orange-500">%×‘</th><th class="p-1"></th></tr>
                                </thead>
                                <tbody id="settingsTableBody" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                        <div class="p-3 bg-slate-50 dark:bg-slate-800 border-t">
                            <button onclick="addNewCourse()" class="w-full py-2 bg-white dark:bg-slate-700 border border-slate-200 text-blue-600 font-bold rounded-xl text-xs hover:bg-blue-50 transition-colors"><i class="fas fa-plus"></i> ×”×•×¡×£ ×§×•×¨×¡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="subCalcModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white dark:bg-dark-card w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-pop"><div class="p-4 bg-blue-600 text-white flex justify-between items-center"><h3 class="font-bold flex items-center gap-2"><i class="fas fa-calculator"></i> ××—×©×‘×•×Ÿ <span id="modalTitleSuffix"></span></h3><button onclick="closeSubCalc()" class="text-white"><i class="fas fa-times"></i></button></div><div class="p-4 space-y-3 max-h-[50vh] overflow-y-auto" id="modalRows"></div><div class="p-4 bg-slate-50 dark:bg-slate-800 space-y-3 border-t"><div class="flex justify-between text-xs font-bold"><span>××©×§×œ ×‘×§×•×¨×¡:</span><span id="modalTotalWeight" class="text-orange-500">0%</span></div><div class="flex justify-between text-lg font-black"><span>×¦×™×•×Ÿ ××©×•×§×œ×œ:</span><span id="modalFinalGrade" class="text-blue-600">0</span></div><div class="grid grid-cols-2 gap-3 mt-4"><button onclick="addSubCalcRow()" class="py-2 border border-blue-600 text-blue-600 rounded-xl font-bold text-xs">×”×•×¡×£ ××˜×œ×”</button><button onclick="applySubCalc()" class="py-2 bg-blue-600 text-white rounded-xl font-bold text-xs">×¢×“×›×Ÿ × ×ª×•× ×™×</button></div></div></div></div>

    <script>
        const defaultData = [
            { id: 'calc', name: '×—×“×•"× 1', semester: 1, credits: 5, work: 100, quiz: 87, weights: { work: 15, quiz: 15 }, exam: 100, workMagen: false, quizMagen: false, isBinary: false, simExam: null },
            { id: 'discrete', name: '×“×™×¡×§×¨×˜×™×ª', semester: 1, credits: 3, work: 100, quiz: 78, weights: { work: 8, quiz: 7 }, exam: 100, workMagen: false, quizMagen: true, isBinary: false, simExam: null },
            { id: 'linear', name: '×œ×™× ××¨×™×ª', semester: 1, credits: 3.5, work: 100, quiz: 90, weights: { work: 15, quiz: 10 }, exam: 100, isBinary: false, simExam: null },
            { id: 'physics', name: '×¤×™×–×™×§×”', semester: 1, credits: 3.5, work: 100, quiz: 0, weights: { work: 10, quiz: 0 }, exam: 100, quizMagen: false, isBinary: false, simExam: null },
            { id: 'linear', name: '××‘×•× ××ª××˜×™', semester: 1, credits: 2.5, work: 100, quiz: 90, weights: { work: 30, quiz: 0 }, exam: 100, isBinary: false, simExam: null }, 
        ];
        let courses = JSON.parse(localStorage.getItem('harelGradesV11_2')) || JSON.parse(JSON.stringify(defaultData));
        courses.forEach(c => { if(c.simExam === undefined) c.simExam = null; });
        let collapsedSemesters = {}; let chart = null; let currentChartType = 'bar'; let activeCalcContext = null;

        function init() {
            if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            const maxSem = courses.length > 0 ? Math.max(...courses.map(c => c.semester)) : 1;
            [...new Set(courses.map(c => c.semester))].forEach(s => { if (s < maxSem) collapsedSemesters[s] = true; });
            updateFilterOptions(); renderAll(); calculateAll();
        }

        function calculateCourseFinal(c, useSim = true) {
            if (c.isBinary) return "×¢×•×‘×¨"; 
            let wp = parseFloat(c.weights.work) || 0, qp = parseFloat(c.weights.quiz) || 0;
            const w = parseFloat(c.work) || 0, q = parseFloat(c.quiz) || 0;
            const ex = (useSim && c.simExam !== null) ? parseFloat(c.simExam) : parseFloat(c.exam) || 0;
            let ew = Math.max(0, 100 - wp - qp);
            if (c.workMagen && w < ex) wp = 0; if (c.quizMagen && q < ex) qp = 0;
            let tw = wp + qp + ew; if (tw === 0) return ex.toFixed(2);
            return Math.min(100, (((w * wp) + (q * qp) + (ex * ew)) / tw)).toFixed(2);
        }

        function calculateAll() {
            let twS=0, tgc=0, tca=0, semStats={}, labels=[], data=[], colors=[], isS=false;
            courses.forEach(c => {
                const cr = parseFloat(c.credits) || 0; tca += cr;
                if (!semStats[c.semester]) semStats[c.semester] = { sum: 0, cr: 0 };
                if (c.isBinary) return; 
                const fS = parseFloat(calculateCourseFinal(c, true));
                if(c.simExam !== null) isS = true; twS += fS * cr; tgc += cr;
                semStats[c.semester].sum += fS * cr; semStats[c.semester].cr += cr;
                if (shouldShowInChart(c)) { labels.push(c.name); data.push(fS); colors.push(getBarColor(fS)); }
            });
            document.getElementById('totalAverage').innerText = tgc > 0 ? (twS / tgc).toFixed(2) : "0.00";
            document.getElementById('totalCredits').innerText = tca;
            document.getElementById('resetSimBtn').classList.toggle('hidden', !isS);
            for (const [s, st] of Object.entries(semStats)) { const el = document.getElementById(`semAvg_${s}`); if (el) el.innerText = st.cr > 0 ? (st.sum / st.cr).toFixed(2) : "0.00"; }
            calculateTarget();
            if (currentChartType === 'ai') updateAIAdvisor(); else updateChart(labels, data, colors, semStats);
        }

        function updateExamLive(i, val) { 
            courses[i].exam = Math.min(100, Math.max(0, parseFloat(val)||0));
            document.getElementById(`examLabel_${i}`).innerText = courses[i].exam;
            const fS = calculateCourseFinal(courses[i], true);
            const fe = document.getElementById(`final_${i}`); if(fe) { fe.innerText = fS; fe.className = `text-3xl font-black ${finalColor(fS)}`; }
            updateMagenBadges(i); calculateAll(); saveData();
        }

        function updateSimLive(i, val) {
            courses[i].simExam = val === "" ? null : Math.min(100, Math.max(0, parseFloat(val)));
            document.getElementById(`simVal_${i}`).innerText = courses[i].simExam !== null ? courses[i].simExam : '--';
            const fS = calculateCourseFinal(courses[i], true), fR = calculateCourseFinal(courses[i], false);
            const fe = document.getElementById(`final_${i}`); if(fe) { fe.innerText = fS; fe.className = `text-3xl font-black ${finalColor(fS)}`; }
            const diff = (parseFloat(fS) - parseFloat(fR)).toFixed(1);
            document.getElementById(`simDiff_${i}`).innerHTML = courses[i].simExam !== null ? `<span class="text-[10px] ${diff>=0?'text-green-500':'text-red-400'} font-bold">${diff>=0?'+':''}${diff}</span>` : '';
            updateMagenBadges(i); calculateAll();
        }

        function updateData(i, f, v, sf = null, el = null) {
            let val = v;
            if(['work','quiz','exam','credits'].includes(f) || (f==='weights'&&sf)) {
                val = Math.min(100, Math.max(0, parseFloat(v)||0));
                if (f==='weights') {
                    let other = sf==='work'?'quiz':'work';
                    if (val + courses[i].weights[other] > 100) courses[i].weights[other] = 100 - val;
                }
                if(el) el.value = val;
            }
            if (f==='isBinary') courses[i].isBinary = !courses[i].isBinary; 
            else if (f==='weights'&&sf) courses[i].weights[sf] = val;
            else if (f==='name') courses[i].name = val;
            else courses[i][f] = (f==='semester') ? parseInt(val)||1 : val;
            saveData(); if (f==='semester') updateFilterOptions();
            renderAll(); calculateAll(); 
        }

        function updateChart(labels, data, colors, semStats) {
            const ctx = document.getElementById('gradeChart').getContext('2d');
            const chartData = currentChartType === 'bar' ? data : Object.keys(semStats).sort().map(s => semStats[s].cr > 0 ? (semStats[s].sum/semStats[s].cr).toFixed(2) : 0);
            const chartLabels = currentChartType === 'bar' ? labels : Object.keys(semStats).sort().map(s => `×¡×' ${s}`);

            if (chart) {
                chart.data.labels = chartLabels;
                chart.data.datasets[0].data = chartData;
                chart.data.datasets[0].backgroundColor = currentChartType === 'bar' ? colors : 'rgba(59, 130, 246, 0.1)';
                chart.update('none'); 
            } else {
                chart = new Chart(ctx, {
                    type: currentChartType === 'bar' ? 'bar' : 'line',
                    data: {
                        labels: chartLabels,
                        datasets: [{ data: chartData, backgroundColor: colors, borderColor: '#3b82f6', tension: 0.4, fill: true }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 }, x: { ticks: { font: { size: 9 } } } } }
                });
            }
        }

        function updateAIAdvisor() {
            const out = document.getElementById('aiTextOutput'), list = document.getElementById('retakeList'), totalCr = courses.reduce((s, c) => s + (c.isBinary ? 0 : parseFloat(c.credits) || 0), 0);
            if (totalCr === 0) { out.innerText = "×”×–×Ÿ ×¦×™×•× ×™× ×›×“×™ ×œ×§×‘×œ ×”××œ×¦×•×ª."; return; }
            
            let insights = courses.filter(c => !c.isBinary).map(c => {
                const cur = parseFloat(calculateCourseFinal(c, true));
                const weight = (parseFloat(c.credits) || 0) / totalCr;
                const impact10pts = (10 * weight).toFixed(2);
                return { name: c.name, gain: (100 - cur) * weight, weight, impact10pts, isSim: c.simExam !== null };
            });
            insights.sort((a, b) => b.gain - a.gain);
            
            out.innerHTML = `× ×™×ª×—×ª×™ ××ª ×”× ×ª×•× ×™× ×©×œ×š. ×”× ×” ×”××‘×—× ×™× ×”×›×™ ×¨×•×•×—×™×™× ×œ×××•×¦×¢ ×”×›×œ×œ×™:`;
            list.innerHTML = '';
            insights.slice(0, 3).forEach((ins, i) => {
                if (ins.gain <= 0.01) return;
                const cols = ['purple', 'blue', 'indigo'];
                list.innerHTML += `<div class="bg-white dark:bg-slate-800 p-2 rounded border-r-4 border-${cols[i]}-500 shadow-sm"><div class="flex justify-between font-bold text-[10px]"><span>${ins.name}</span><span class="text-green-500">+${ins.gain.toFixed(2)} ×œ×××•×¦×¢</span></div><p class="text-[9px] text-slate-400">×›×œ 10 × ×§×•×“×•×ª ×©×ª×©×¤×¨ ×¤×” ×©×•×•×ª <b>${ins.impact10pts}</b> ×‘×××•×¦×¢ ×”×›×œ×œ×™.</p></div>`;
            });
        }

        function openSubCalc(i, t) {
            activeCalcContext = { index: i, type: t };
            document.getElementById('modalTitleSuffix').innerText = t === 'work' ? '×¢×‘×•×“×•×ª' : '×‘×—× ×™×';
            document.getElementById('modalRows').innerHTML = ''; 
            addSubCalcRow(); addSubCalcRow();
            document.getElementById('subCalcModal').classList.remove('hidden');
            updateModalResults();
        }
        function closeSubCalc() { document.getElementById('subCalcModal').classList.add('hidden'); activeCalcContext = null; }
        function addSubCalcRow() {
            const d = document.createElement('div'); d.className = "grid grid-cols-12 gap-2 items-center subcalc-row";
            d.innerHTML = `<div class="col-span-7"><input type="number" placeholder="×¦×™×•×Ÿ" min="0" max="100" oninput="updateModalResults()" class="sub-grade w-full bg-white dark:bg-slate-800 border border-slate-200 rounded-lg p-2 text-center text-sm outline-none"></div><div class="col-span-4"><input type="number" placeholder="% ××©×§×œ" min="0" max="100" oninput="updateModalResults()" class="sub-weight w-full bg-white dark:bg-slate-800 border border-slate-200 rounded-lg p-2 text-center text-sm outline-none"></div><div class="col-span-1 text-center"><button onclick="this.parentElement.parentElement.remove(); updateModalResults();" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button></div>`;
            document.getElementById('modalRows').appendChild(d);
        }
        function updateModalResults() {
            let tw = 0, ws = 0; 
            document.querySelectorAll('.subcalc-row').forEach(r => { 
                let gIn = r.querySelector('.sub-grade'), wIn = r.querySelector('.sub-weight');
                if (parseFloat(gIn.value) > 100) gIn.value = 100;
                if (parseFloat(wIn.value) > 100) wIn.value = 100;
                let g = parseFloat(gIn.value)||0, w = parseFloat(wIn.value)||0;
                if(w>0){tw+=w; ws+=(g*w);}
            });
            document.getElementById('modalTotalWeight').innerText = tw.toFixed(1) + '%';
            document.getElementById('modalFinalGrade').innerText = tw > 0 ? (ws/tw).toFixed(2) : "0";
        }
        function applySubCalc() {
            if (!activeCalcContext) return;
            let tw = 0, ws = 0;
            document.querySelectorAll('.subcalc-row').forEach(r => {
                let g = parseFloat(r.querySelector('.sub-grade').value)||0;
                let w = parseFloat(r.querySelector('.sub-weight').value)||0;
                if(w>0){tw+=w; ws+=(g*w);}
            });
            const { index, type } = activeCalcContext;
            const newWeight = Math.min(100, tw);
            if (type === 'work') {
                courses[index].work = (ws/tw)||0; courses[index].weights.work = newWeight;
                if (newWeight + courses[index].weights.quiz > 100) courses[index].weights.quiz = 100 - newWeight;
            } else {
                courses[index].quiz = (ws/tw)||0; courses[index].weights.quiz = newWeight;
                if (newWeight + courses[index].weights.work > 100) courses[index].weights.work = 100 - newWeight;
            }
            saveData(); renderAll(); calculateAll(); closeSubCalc();
        }

        function updateMagenBadges(i) { const c=courses[i], el=document.getElementById(`magenBox_${i}`); if(!el)return; const ex=c.simExam!==null?c.simExam:c.exam; let h=''; if(c.workMagen) h+=`<span class="magen-badge text-[8px] ${parseFloat(c.work)<parseFloat(ex)?'bg-slate-100 text-slate-500':'bg-green-100 text-green-600'} px-1.5 py-0.5 rounded border border-slate-200 ml-1">×¢×‘' ${parseFloat(c.work)<parseFloat(ex)?'ğŸ›¡ï¸':'âœ…'}</span>`; if(c.quizMagen) h+=`<span class="magen-badge text-[8px] ${parseFloat(c.quiz)<parseFloat(ex)?'bg-slate-100 text-slate-500':'bg-green-100 text-green-600'} px-1.5 py-0.5 rounded border border-slate-200 ml-1">×‘×—×Ÿ ${parseFloat(c.quiz)<parseFloat(ex)?'ğŸ›¡ï¸':'âœ…'}</span>`; el.innerHTML=h; }
        function setChartType(t) { currentChartType = t; ['bar', 'line', 'ai'].forEach(id => document.getElementById(`btn-${id}`).classList.toggle('active-tab', id === t)); document.getElementById('gradeChart').style.display = t === 'ai' ? 'none' : 'block'; document.getElementById('aiAdvisorContent').classList.toggle('hidden', t !== 'ai'); document.getElementById('filterContainer').style.visibility = t === 'ai' ? 'hidden' : 'visible'; if(chart){chart.destroy(); chart=null;} calculateAll(); }
        function toggleTheme() { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); calculateAll(); }
        function enforceMax(el) { if (parseFloat(el.value) > 100) el.value = 100; if (parseFloat(el.value) < 0) el.value = 0; }
        function saveData() { localStorage.setItem('harelGradesV11_2', JSON.stringify(courses)); }
        function updateFilterOptions() { const s=document.getElementById('scopeFilter'), ms=courses.length>0?Math.max(...courses.map(c=>c.semester)):1; let h='<option value="all">×›×œ ×”×ª×•××¨</option>'; for(let i=1;i<=Math.ceil(ms/2);i++)h+=`<option value="year_${i}">×©× ×” ${['×','×‘','×’','×“'][i-1]||i}</option>`; h+=`<option value="sem_${ms}">×¡××¡×˜×¨ ××—×¨×•×Ÿ (${ms})</option>`; s.innerHTML=h; }
        function shouldShowInChart(c) { const f=document.getElementById('scopeFilter').value; if(f==='all')return true; if(f.startsWith('sem_'))return c.semester===parseInt(f.split('_')[1]); if(f.startsWith('year_')){const y=parseInt(f.split('_')[1]); return c.semester>=y*2-1 && c.semester<=y*2;} return true; }
        function getBarColor(g) { const n = parseFloat(g); return n >= 90 ? '#10b981' : (n >= 80 ? '#3b82f6' : (n >= 60 ? '#eab308' : '#ef4444')); }
        function finalColor(g) { const n = parseFloat(g); return n >= 90 ? 'text-emerald-500' : (n >= 80 ? 'text-blue-600' : (n >= 60 ? 'text-yellow-500' : 'text-red-500')); }
        function startNewSemester() { const ms = courses.length > 0 ? Math.max(...courses.map(c => c.semester)) : 0; courses.push({ id: Date.now(), name: '×§×•×¨×¡ ×—×“×©', semester: ms+1, credits: 3, work: 100, quiz: 0, weights: { work: 10, quiz: 0 }, exam: 60, isBinary: false, simExam: null }); saveData(); updateFilterOptions(); renderAll(); calculateAll(); }
        function addNewCourse() { const ms = courses.length > 0 ? Math.max(...courses.map(c => c.semester)) : 1; courses.push({ id: Date.now(), name: '×§×•×¨×¡ ×—×“×©', semester: ms, credits: 3, work: 100, quiz: 0, weights: { work: 10, quiz: 0 }, exam: 60, isBinary: false, simExam: null }); saveData(); updateFilterOptions(); renderAll(); calculateAll(); }
        function resetAllSimulations() { courses.forEach(c => c.simExam = null); renderAll(); calculateAll(); }
        function exportData() { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(courses,null,2)],{type:"application/json"})); a.download=`Grades.json`; a.click(); }
        
        // --- ×¤×•× ×§×¦×™×™×ª ×˜×¢×™× ×” (Import) ××ª×•×§× ×ª ---
        function triggerImport() { document.getElementById('importFile').click(); }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        courses = data;
                        saveData();
                        renderAll();
                        calculateAll();
                        alert('×”× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×”!');
                    } else if (data.courses && Array.isArray(data.courses)) {
                        // ×ª××™×›×” ×‘×¤×•×¨××˜ ××•×¨×›×‘ ×™×•×ª×¨ ×× ×ª×¨×¦×” ×‘×¢×ª×™×“
                        courses = data.courses;
                        saveData();
                        renderAll();
                        calculateAll();
                        alert('×”× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×”!');
                    }
                } catch (err) {
                    alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥. ×•×•×“× ×©××“×•×‘×¨ ×‘×§×•×‘×¥ JSON ×ª×§×™×Ÿ.');
                }
                // ××™×¤×•×¡ ×”×¢×¨×š ×›×“×™ ×œ××¤×©×¨ ×˜×¢×™× ×” ×—×•×–×¨×ª ×©×œ ××•×ª×• ×§×•×‘×¥ ×× ×ª×¨×¦×”
                input.value = '';
            };
            reader.readAsText(file);
        }

        function removeCourse(i) { if(confirm("×œ××—×•×§?")) { courses.splice(i,1); saveData(); renderAll(); calculateAll(); } }
        function resetDefaults() { if(confirm("×œ××¤×¡?")) { courses = JSON.parse(JSON.stringify(defaultData)); saveData(); renderAll(); calculateAll(); } }
        function toggleMagen(i, type) { if(type==='work') courses[i].workMagen = !courses[i].workMagen; else courses[i].quizMagen = !courses[i].quizMagen; saveData(); renderAll(); calculateAll(); }

        function calculateTarget() { const t = Math.min(100, parseFloat(document.getElementById('targetInput').value)); const res = document.getElementById('targetResult'); if(!t){res.innerText="---"; return;} let tc=0, cp=0, tewc=0; courses.forEach(c=>{ if(c.isBinary) return; const cr=parseFloat(c.credits)||0; tc+=cr; const ew=Math.max(0, 100-(c.weights.work||0)-(c.weights.quiz||0)); cp+=((c.work||0)*(c.weights.work||0)/100+(c.quiz||0)*(c.weights.quiz||0)/100)*cr; tewc+=cr*(ew/100); }); if(tc===0||tewc<=0)return; const n=Math.ceil(((t*tc)-cp)/tewc); res.innerHTML=n>100?`<span class="text-red-500">${n} ğŸ˜±</span>`:(n<0?`<span class="text-green-500">×¢×‘×¨×ª!</span>`:n); }

        function renderAll() {
            const w = document.getElementById('semesterWrapper'); w.innerHTML = '';
            const sems = [...new Set(courses.map(c => c.semester))].sort((a,b) => a-b);
            sems.forEach(s => {
                w.innerHTML += `<div class="bg-white dark:bg-dark-card rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border overflow-hidden"><div class="p-4 bg-slate-50 dark:bg-slate-800/50 flex items-center justify-between cursor-pointer" onclick="document.getElementById('semContainer_${s}').classList.toggle('hidden-content'); document.getElementById('semIcon_${s}').classList.toggle('rotate-180')"><div class="flex items-center gap-3"><i id="semIcon_${s}" class="fas fa-chevron-down text-slate-400 transition-transform"></i><h2 class="text-lg font-black text-slate-700 dark:text-slate-200">×¡××¡×˜×¨ ${s}</h2></div><div class="bg-white dark:bg-slate-700 px-3 py-1 rounded-full border border-slate-200 shadow-sm"><span id="semAvg_${s}" class="text-lg font-bold text-blue-600">0.00</span></div></div><div id="semContainer_${s}" class="p-4 space-y-4 border-t border-slate-100 dark:border-slate-700/50"></div></div>`;
                courses.forEach((c, i) => {
                    if (c.semester !== s) return;
                    const f = calculateCourseFinal(c, true); const isS = c.simExam !== null;
                    document.getElementById(`semContainer_${s}`).innerHTML += `<div class="bg-white dark:bg-dark-card p-4 rounded-xl border border-slate-100 dark:border-dark-border hover:border-blue-300 transition-colors group"><div class="flex flex-col sm:flex-row items-center gap-4"><div class="flex-1 w-full"><div class="flex justify-between items-center mb-2"><div class="flex items-center gap-1"><h3 class="font-bold text-slate-700 dark:text-slate-200 text-lg">${c.name}</h3><div id="magenBox_${i}"></div></div><span class="text-[10px] text-slate-500 bg-slate-100 dark:bg-slate-900 px-2 py-1 rounded">${c.credits} × ×§"×–</span></div>${c.isBinary ? '<div class="text-green-500 font-bold text-xl"><i class="fas fa-check-circle"></i> ×¢×•×‘×¨</div>' : `<div class="space-y-3"><div class="flex items-center gap-3"><div class="w-10 text-center"><span class="text-sm font-bold text-blue-600" id="examLabel_${i}">${c.exam}</span><p class="text-[8px] text-slate-400">×××ª</p></div><div class="flex-1 pt-1"><input type="range" min="0" max="100" value="${c.exam}" oninput="updateExamLive(${i}, this.value)" class="accent-blue-600"></div></div><div class="flex items-center gap-3 bg-indigo-50/50 dark:bg-indigo-900/10 p-2 rounded-lg"><div class="w-10 text-center"><span class="text-sm font-bold text-indigo-600" id="simVal_${i}">${isS?c.simExam:'--'}</span><p class="text-[8px] text-indigo-400 font-bold uppercase">××” ××?</p></div><div class="flex-1 pt-1"><input type="range" min="0" max="100" value="${isS?c.simExam:c.exam}" oninput="updateSimLive(${i},this.value)" class="accent-indigo-600 sim-slider"></div><button onclick="updateSimLive(${i},'')" class="text-[10px] text-slate-300 hover:text-red-400"><i class="fas fa-times-circle"></i></button></div></div>`}</div>${c.isBinary?'':`<div class="text-center w-full sm:w-24 sm:pl-4 sm:border-r border-slate-100 dark:border-slate-700"><div class="text-[10px] text-slate-400 font-bold uppercase">×¡×•×¤×™</div><div id="final_${i}" class="text-3xl font-black ${finalColor(f)}">${f}</div><div id="simDiff_${i}"></div></div>`}</div></div>`;
                    updateMagenBadges(i);
                });
            });
            renderTable();
        }

        function renderTable() {
            const tb = document.getElementById('settingsTableBody'); tb.innerHTML = '';
            const sems = [...new Set(courses.map(c => c.semester))].sort((a,b) => a-b);
            sems.forEach(s => {
                const isc = collapsedSemesters[s];
                tb.innerHTML += `<tr class="bg-slate-100 dark:bg-slate-700 cursor-pointer font-bold" onclick="collapsedSemesters[${s}]=!collapsedSemesters[${s}]; renderTable();"><td colspan="9" class="p-1.5 pr-4 text-xs"><i class="fas fa-chevron-up text-[8px] transition-transform ${isc?'rotate-180':''}"></i> ×¡××¡×˜×¨ ${s}</td></tr>`;
                if (!isc) {
                    courses.forEach((c, i) => {
                        if (c.semester !== s) return;
                        const bin = c.isBinary;
                        tb.innerHTML += `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors border-b border-slate-100 dark:border-slate-700">
                            <td class="p-1"><input type="text" value="${c.name}" onchange="updateData(${i},'name',this.value)" class="input-minimal text-right w-20"></td>
                            <td class="p-1 text-center"><input type="checkbox" onchange="updateData(${i},'isBinary')" ${bin?'checked':''} class="w-3 h-3 cursor-pointer"></td>
                            <td class="p-1"><input type="number" value="${c.semester}" onchange="updateData(${i},'semester',this.value)" class="input-minimal w-10 text-center"></td>
                            <td class="p-1"><input type="number" value="${c.credits}" onchange="updateData(${i},'credits',this.value, null, this)" class="input-minimal w-10 text-center"></td>
                            <td class="p-1 ${bin?'opacity-20 pointer-events-none':''}"><div class="flex items-center gap-1 justify-center"><input type="number" value="${Math.round(c.work)}" onchange="updateData(${i},'work',this.value, null, this)" class="input-minimal text-blue-600 w-10"> <button onclick="openSubCalc(${i},'work')" class="text-[9px] text-slate-400 hover:text-blue-500"><i class="fas fa-calculator"></i></button></div></td>
                            <td class="p-1 ${bin?'opacity-20 pointer-events-none':''}"><div class="flex items-center gap-1 justify-center"><input type="number" value="${Math.round(c.quiz)}" onchange="updateData(${i},'quiz',this.value, null, this)" class="input-minimal text-blue-600 w-10"> <button onclick="openSubCalc(${i},'quiz')" class="text-[9px] text-slate-400 hover:text-blue-500"><i class="fas fa-calculator"></i></button></div></td>
                            <td class="p-1 ${bin?'opacity-20 pointer-events-none':''}"><div class="flex items-center gap-0.5 justify-center"><input type="number" value="${c.weights.work}" onchange="updateData(${i},'weights',this.value,'work', this)" class="input-minimal text-orange-600 w-8"> <button onclick="toggleMagen(${i},'work')" class="text-[9px] ${c.workMagen?'text-green-500':'text-slate-300'}"><i class="fas fa-shield-alt"></i></button></div></td>
                            <td class="p-1 ${bin?'opacity-20 pointer-events-none':''}"><div class="flex items-center gap-0.5 justify-center"><input type="number" value="${c.weights.quiz}" onchange="updateData(${i},'weights',this.value,'quiz', this)" class="input-minimal text-orange-600 w-8"> <button onclick="toggleMagen(${i},'quiz')" class="text-[9px] ${c.quizMagen?'text-green-500':'text-slate-300'}"><i class="fas fa-shield-alt"></i></button></div></td>
                            <td class="p-1 text-center"><button onclick="removeCourse(${i})" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-times"></i></button></td>
                        </tr>`;
                    });
                }
            });
        }
        init();
    </script>
</body>
</html>


