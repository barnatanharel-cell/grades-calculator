<!DOCTYPE html>
<html lang="he" dir="rtl" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××—×©×‘×•×Ÿ ×¦×™×•× ×™×</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#0f172a', card: '#1e293b', text: '#f1f5f9', border: '#334155' }
                    }
                }
            }
        }
    </script>
    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        .card-transition { transition: all 0.3s ease; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        input[type=range] { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 5px; background: #e2e8f0; outline: none; }
        .dark input[type=range] { background: #334155; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #3b82f6; cursor: pointer; }
        
        .input-minimal { background: transparent; border-bottom: 1px solid transparent; width: 100%; padding: 4px 2px; text-align: center; outline: none; transition: all 0.2s; font-variant-numeric: tabular-nums; }
        .input-minimal:focus { border-bottom-color: #3b82f6; background-color: rgba(59, 130, 246, 0.1); }
        .dark .input-minimal { color: #e2e8f0; }

        .rotate-180 { transform: rotate(180deg); }
        .hidden-badge { display: none !important; } 
        .hidden-content { display: none; }
        .active-tab { background-color: #3b82f6 !important; color: white !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .modal-overlay { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.26, 0.53, 0.74, 1.48); }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* ×ª×™×§×•×Ÿ ×œ×‘××’ ×”×›×™×•×•×¥ ×©×œ ×”××’×Ÿ */
        .magen-badge { whitespace: nowrap; min-width: max-content; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-dark-bg dark:text-dark-text min-h-screen p-4 md:p-8 font-sans">
    
    <div class="max-w-[1600px] mx-auto space-y-8">
        
        <div class="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-sm border-r-4 border-blue-600 card-transition flex flex-col xl:flex-row justify-between items-center gap-6 sticky top-0 z-50 bg-opacity-95 backdrop-blur-md">
            <div class="flex items-center gap-4 w-full xl:w-auto">
                <div class="p-3 bg-blue-50 dark:bg-blue-900/30 rounded-xl text-blue-600 dark:text-blue-400">
                    <i class="fas fa-calculator text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-black tracking-tight">××—×©×‘×•×Ÿ ×¦×™×•× ×™×</h1>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 items-center bg-indigo-50 dark:bg-slate-700/50 p-3 rounded-xl border border-indigo-100 dark:border-slate-600 w-full xl:w-auto">
                <div class="flex items-center gap-3">
                    <div class="text-right">
                        <span class="text-[10px] font-bold text-indigo-500 dark:text-indigo-300 uppercase block">×”×’×“×¨ ×™×¢×“</span>
                        <input type="number" id="targetInput" placeholder="85" oninput="calculateTarget()" 
                               class="w-16 bg-white dark:bg-slate-800 border border-indigo-200 dark:border-slate-600 rounded px-1 text-center font-bold text-indigo-700 dark:text-indigo-300 outline-none">
                    </div>
                    <div class="h-8 w-px bg-indigo-200 dark:bg-slate-600"></div>
                    <div>
                        <div id="targetResult" class="text-lg font-bold text-indigo-900 dark:text-indigo-200 leading-none">---</div>
                        <div class="text-[10px] text-indigo-400 dark:text-slate-400">× ×“×¨×© ×‘××‘×—× ×™×</div>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-6 w-full xl:w-auto justify-between xl:justify-end">
                <button onclick="toggleTheme()" class="p-3 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-yellow-400 hover:scale-110 transition shadow-sm">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline"></i>
                </button>

                <div class="text-right">
                    <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">×××•×¦×¢ ×œ×ª×•××¨</div>
                    <div id="totalAverage" class="text-5xl font-black text-blue-600 dark:text-blue-400 leading-none">00.00</div>
                    <div class="text-xs text-slate-400 mt-1">×¡×”"×› × ×§"×–: <span id="totalCredits">0</span></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 items-start">
            <div class="xl:col-span-7 space-y-8">
                <div id="semesterWrapper" class="space-y-6"></div>
                <button onclick="startNewSemester()" class="w-full py-4 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl text-slate-500 dark:text-slate-400 font-bold hover:bg-slate-50 dark:hover:bg-slate-800 hover:border-blue-400 transition flex items-center justify-center gap-2">
                    <i class="fas fa-layer-group text-xl"></i> ×¤×ª×— ×¡××¡×˜×¨ ×—×“×©
                </button>
            </div>

            <div class="xl:col-span-5 space-y-6 sticky top-28">
                <div class="bg-white dark:bg-dark-card p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border card-transition">
                    <div class="flex flex-col gap-4 mb-4">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 text-sm flex items-center">
                                <i class="fas fa-chart-pie text-purple-500 ml-2"></i>× ×™×ª×•×— × ×ª×•× ×™×
                            </h3>
                            <div class="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1 gap-1">
                                <button onclick="setChartType('bar')" id="btn-bar" class="text-xs px-3 py-1 rounded-md transition active-tab"><i class="fas fa-chart-bar"></i></button>
                                <button onclick="setChartType('line')" id="btn-line" class="text-xs px-3 py-1 rounded-md transition hover:bg-white dark:hover:bg-slate-700"><i class="fas fa-chart-line"></i></button>
                                <button onclick="setChartType('doughnut')" id="btn-doughnut" class="text-xs px-3 py-1 rounded-md transition hover:bg-white dark:hover:bg-slate-700"><i class="fas fa-chart-pie"></i></button>
                            </div>
                        </div>
                        <div class="relative">
                            <select id="scopeFilter" onchange="calculateAll()" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-300 text-xs rounded-lg p-2 outline-none cursor-pointer">
                                <option value="all">×›×œ ×”×ª×•××¨</option>
                            </select>
                        </div>
                    </div>
                    <div class="h-64 relative">
                        <canvas id="gradeChart"></canvas>
                    </div>
                </div>

                <div class="bg-white dark:bg-dark-card rounded-2xl shadow-lg border border-slate-200 dark:border-dark-border overflow-hidden flex flex-col max-h-[60vh] card-transition">
                    <div class="p-4 bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="font-bold text-slate-700 dark:text-slate-200 text-sm"><i class="fas fa-sliders-h text-blue-500 ml-2"></i> ×¢×¨×™×›×ª × ×ª×•× ×™×</h2>
                        <div class="flex gap-2 items-center">
                            <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">
                            <button onclick="exportData()" class="text-xs text-slate-500 hover:text-blue-600 transition p-1" title="×™×™×¦× ×’×™×‘×•×™"><i class="fas fa-download"></i></button>
                            <button onclick="triggerImport()" class="text-xs text-slate-500 hover:text-blue-600 transition p-1" title="×™×™×‘× ×’×™×‘×•×™"><i class="fas fa-upload"></i></button>
                            <button onclick="resetDefaults()" class="text-xs text-slate-400 hover:text-red-500 transition p-1" title="××™×¤×•×¡"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    
                    <div class="overflow-auto custom-scrollbar p-1">
                        <table class="w-full text-[11px] border-collapse">
                            <thead class="text-[9px] text-slate-400 uppercase font-semibold bg-white dark:bg-dark-card sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-2 text-right">×§×•×¨×¡</th>
                                    <th class="p-1">×‘×™× ××¨×™</th> 
                                    <th class="p-1">×¡×'</th>
                                    <th class="p-1">× ×§"×–</th>
                                    <th class="p-1 text-blue-500">×¢×‘'</th>
                                    <th class="p-1 text-blue-500">×‘×—×Ÿ</th>
                                    <th class="p-1 text-orange-500">%×¢</th>
                                    <th class="p-1 text-orange-500">%×‘</th>
                                    <th class="p-1"></th>
                                </tr>
                            </thead>
                            <tbody id="settingsTableBody" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                        </table>
                    </div>

                    <div class="p-3 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800">
                        <button onclick="addNewCourse()" class="w-full py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-blue-600 dark:text-blue-400 font-bold rounded-xl text-sm flex items-center justify-center gap-2">
                            <i class="fas fa-plus"></i> ×”×•×¡×£ ×§×•×¨×¡ ×œ×¨×©×™××”
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="subCalcModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white dark:bg-dark-card w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-pop">
            <div class="p-4 border-b bg-blue-600 text-white flex justify-between items-center">
                <h3 class="font-bold flex items-center gap-2"><i class="fas fa-calculator"></i> ××—×©×‘×•×Ÿ ××©× ×”: <span id="modalTitle"></span></h3>
                <button onclick="closeSubCalc()" class="text-white hover:text-slate-200"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 space-y-3 max-h-[50vh] overflow-y-auto" id="modalRows"></div>
            <div class="p-4 bg-slate-50 dark:bg-slate-800/50 space-y-3 border-t border-slate-200 dark:border-slate-600">
                <div class="flex justify-between text-xs font-bold"><span class="text-slate-500">××©×§×œ ×›×•×œ×œ ××”×§×•×¨×¡:</span><span id="modalTotalWeight" class="text-orange-500">0%</span></div>
                <div class="flex justify-between text-lg font-black"><span class="text-slate-700 dark:text-slate-200">×¦×™×•×Ÿ ××©×•×§×œ×œ:</span><span id="modalFinalGrade" class="text-blue-600">0</span></div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="addSubCalcRow()" class="py-2 px-4 border border-blue-600 text-blue-600 rounded-xl hover:bg-blue-50 transition font-bold text-xs"><i class="fas fa-plus ml-1"></i> ×”×•×¡×£ ××˜×œ×”</button>
                    <button onclick="applySubCalc()" class="py-2 px-4 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition font-bold text-xs">×¢×“×›×Ÿ × ×ª×•× ×™×</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Core Data ---
        const defaultData = [
            { id: 'calc', name: '×—×“×•"× 1', semester: 1, credits: 5, work: 100, quiz: 85, weights: { work: 10, quiz: 10 }, exam: 80, workMagen: false, quizMagen: true, isBinary: false },
            { id: 'linear', name: '×œ×™× ××¨×™×ª', semester: 1, credits: 3.5, work: 100, quiz: 90, weights: { work: 15, quiz: 15 }, exam: 75, isBinary: false },
        ];
        let courses = JSON.parse(localStorage.getItem('harelGradesV11_2')) || JSON.parse(JSON.stringify(defaultData));
        
        let collapsedSemesters = {}; 
        let chart = null;
        let currentChartType = 'bar';
        let activeCalcContext = null;

        function init() {
            if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
            const maxSem = courses.length > 0 ? Math.max(...courses.map(c => c.semester)) : 1;
            [...new Set(courses.map(c => c.semester))].forEach(s => { if (s < maxSem) collapsedSemesters[s] = true; });
            updateFilterOptions(); 
            renderAll();
            calculateAll();
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            calculateAll();
        }

        // --- Colors ---
        function getGradeColor(g) {
            if (g === "×¢×•×‘×¨") return 'text-green-500';
            const n = parseFloat(g);
            if (n >= 90) return 'text-emerald-500 dark:text-emerald-400';
            if (n >= 80) return 'text-blue-600 dark:text-blue-400';
            if (n >= 60) return 'text-yellow-500 dark:text-yellow-400';
            return 'text-red-500 dark:text-red-400';
        }
        function getBarColor(g) {
            const n = parseFloat(g);
            if (n >= 90) return '#10b981';
            if (n >= 80) return '#3b82f6';
            if (n >= 60) return '#eab308';
            return '#ef4444';
        }

        // --- Chart ---
        function updateChart(labels, data, colors, avg, semStats, distro) {
            const ctx = document.getElementById('gradeChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#cbd5e1' : '#64748b';
            const gridColor = isDark ? '#334155' : '#f1f5f9';

            if (chart && chart.config.type !== (currentChartType === 'bar' ? 'bar' : (currentChartType === 'line' ? 'line' : 'doughnut'))) {
                chart.destroy(); chart = null;
            }

            if (currentChartType === 'bar') {
                const ds = [{ label: '×¦×™×•×Ÿ', data, backgroundColor: colors, borderRadius: 4, order: 2 }, { label: '×××•×¦×¢', data: new Array(data.length).fill(parseFloat(avg)), borderColor: '#a855f7', borderWidth: 2, borderDash: [5,5], pointRadius: 0, type: 'line', order: 1 }];
                if (!chart) chart = new Chart(ctx, { type: 'bar', data: { labels, datasets: ds }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, grid: { color: gridColor }, ticks: { color: textColor } }, x: { ticks: { color: textColor, maxRotation: 45, font: { size: 9 } } } }, plugins: { legend: { display: false } } } });
                else { chart.data.labels = labels; chart.data.datasets[0].data = data; chart.data.datasets[0].backgroundColor = colors; chart.data.datasets[1].data = new Array(data.length).fill(parseFloat(avg)); chart.update('none'); }
            } else if (currentChartType === 'line') {
                const sl = Object.keys(semStats).sort((a,b)=>a-b).map(s => `×¡×' ${s}`);
                const sd = Object.keys(semStats).sort((a,b)=>a-b).map(s => (semStats[s].creds>0 ? semStats[s].sum/semStats[s].creds : 0).toFixed(2));
                if (!chart) chart = new Chart(ctx, { type: 'line', data: { labels: sl, datasets: [{ label: '×××•×¦×¢', data: sd, borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { color: textColor } }, x: { ticks: { color: textColor } } }, plugins: { legend: { display: false } } } });
                else { chart.data.labels = sl; chart.data.datasets[0].data = sd; chart.update('none'); }
            } else {
                const dd = Object.values(distro);
                if (!chart) chart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(distro), datasets: [{ data: dd, backgroundColor: ['#10b981', '#3b82f6', '#eab308', '#f97316', '#ef4444'] }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right', labels: { color: textColor, boxWidth: 10, font: { size: 10 } } } } } });
                else { chart.data.datasets[0].data = dd; chart.update('none'); }
            }
        }

        // --- Logic ---
        function calculateCourseFinal(c) {
            if (c.isBinary) return "×¢×•×‘×¨"; 
            let wp = parseFloat(c.weights.work) || 0, qp = parseFloat(c.weights.quiz) || 0;
            const w = parseFloat(c.work) || 0, q = parseFloat(c.quiz) || 0, ex = parseFloat(c.exam) || 0;
            if (c.workMagen && w < ex) wp = 0;
            if (c.quizMagen && q < ex) qp = 0;
            return (((w * wp) + (q * qp) + (ex * (100 - wp - qp))) / 100).toFixed(2);
        }

        function calculateAll() {
            let tw = 0, tgc = 0, tca = 0, semStats = {};
            let labels = [], data = [], colors = [], distro = { '90+': 0, '80-89': 0, '70-79': 0, '60-69': 0, '0-59': 0 };

            courses.forEach(c => {
                const cr = parseFloat(c.credits) || 0; tca += cr;
                if (!semStats[c.semester]) semStats[c.semester] = { sum: 0, creds: 0 };
                if (c.isBinary) return; 
                const final = parseFloat(calculateCourseFinal(c));
                tw += final * cr; tgc += cr;
                semStats[c.semester].sum += final * cr; semStats[c.semester].creds += cr;
                if (shouldShowInChart(c)) {
                    labels.push(c.name); data.push(final); colors.push(getBarColor(final));
                    if (final >= 90) distro['90+']++; else if (final >= 80) distro['80-89']++; else if (final >= 70) distro['70-79']++; else if (final >= 60) distro['60-69']++; else distro['0-59']++;
                }
            });

            document.getElementById('totalAverage').innerText = tgc > 0 ? (tw / tgc).toFixed(2) : "0.00";
            document.getElementById('totalCredits').innerText = tca; 
            for (const [s, st] of Object.entries(semStats)) {
                const el = document.getElementById(`semAvg_${s}`);
                if (el) el.innerText = st.creds > 0 ? (st.sum / st.creds).toFixed(2) : "0.00";
            }
            calculateTarget();
            updateChart(labels, data, colors, tgc > 0 ? (tw / tgc).toFixed(2) : 0, semStats, distro);
        }

        function calculateTarget() {
            const target = parseFloat(document.getElementById('targetInput').value);
            const res = document.getElementById('targetResult');
            if (!target) { res.innerText = "---"; return; }
            let tc = 0, cp = 0, tewc = 0;
            courses.forEach(c => {
                if(c.isBinary) return;
                const cr = parseFloat(c.credits) || 0; tc += cr;
                const ew = Math.max(0, 100 - (c.weights.work||0) - (c.weights.quiz||0));
                cp += ((c.work||0)*(c.weights.work||0)/100 + (c.quiz||0)*(c.weights.quiz||0)/100) * cr;
                tewc += cr * (ew/100);
            });
            if (tc === 0 || tewc <= 0) return;
            const needed = Math.ceil(((target * tc) - cp) / tewc);
            res.innerHTML = needed > 100 ? `<span class="text-red-500">${needed} ğŸ˜±</span>` : (needed < 0 ? `<span class="text-green-500">×¢×‘×¨×ª!</span>` : needed);
        }

        // --- UI Utils ---
        function updateData(i, f, v, sf = null) {
            const of = parseFloat(calculateCourseFinal(courses[i]));
            if (f === 'isBinary') courses[i].isBinary = !courses[i].isBinary; 
            else if (f === 'weights' && sf) courses[i].weights[sf] = parseFloat(v) || 0;
            else if (f === 'name') courses[i].name = v;
            else courses[i][f] = (f === 'semester') ? parseInt(v)||1 : parseFloat(v)||0;
            saveData();
            if (f === 'semester') updateFilterOptions();
            const nf = parseFloat(calculateCourseFinal(courses[i]));
            if (nf >= 100 && of < 100) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            if (['semester', 'name', 'credits', 'isBinary'].includes(f)) renderAll(); else refreshSingleCard(i);
            calculateAll();
        }

        function toggleMagen(i, t) {
            const of = parseFloat(calculateCourseFinal(courses[i]));
            if (t === 'work') courses[i].workMagen = !courses[i].workMagen; else courses[i].quizMagen = !courses[i].quizMagen;
            saveData(); const nf = parseFloat(calculateCourseFinal(courses[i]));
            if (nf >= 100 && of < 100) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            refreshSingleCard(i); renderTable(); calculateAll();
        }

        function setChartType(t) { 
            currentChartType = t; 
            ['bar', 'line', 'doughnut'].forEach(id => {
                const b = document.getElementById(`btn-${id}`);
                b.classList.toggle('active-tab', id === t);
                if (id !== t) b.classList.add('hover:bg-white', 'dark:hover:bg-slate-700'); else b.classList.remove('hover:bg-white', 'dark:hover:bg-slate-700');
            });
            calculateAll(); 
        }

        function openSubCalc(i, t) {
            activeCalcContext = { index: i, type: t };
            document.getElementById('modalTitle').innerText = `${courses[i].name} (${t === 'work' ? '×¢×‘×•×“×•×ª' : '×‘×—× ×™×'})`;
            document.getElementById('modalRows').innerHTML = '';
            addSubCalcRow(); addSubCalcRow();
            document.getElementById('subCalcModal').classList.remove('hidden');
            updateModalResults();
        }
        function closeSubCalc() { document.getElementById('subCalcModal').classList.add('hidden'); }
        function addSubCalcRow() {
            const d = document.createElement('div'); d.className = "grid grid-cols-12 gap-2 items-center mb-2 subcalc-row";
            d.innerHTML = `<div class="col-span-7"><input type="number" placeholder="×¦×™×•×Ÿ" oninput="updateModalResults()" class="sub-grade w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-center text-sm outline-none focus:border-blue-500"></div><div class="col-span-4"><input type="number" placeholder="% ××©×§×œ" oninput="updateModalResults()" class="sub-weight w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-center text-sm outline-none focus:border-blue-500"></div><div class="col-span-1 text-center"><button onclick="this.parentElement.parentElement.remove(); updateModalResults();" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button></div>`;
            document.getElementById('modalRows').appendChild(d);
        }
        function updateModalResults() {
            let tw = 0, ws = 0;
            document.querySelectorAll('.subcalc-row').forEach(r => {
                const g = parseFloat(r.querySelector('.sub-grade').value) || 0, w = parseFloat(r.querySelector('.sub-weight').value) || 0;
                if (w > 0) { tw += w; ws += (g * w); }
            });
            document.getElementById('modalTotalWeight').innerText = tw.toFixed(1) + '%';
            document.getElementById('modalFinalGrade').innerText = tw > 0 ? (ws / tw).toFixed(2) : "0";
        }
        function applySubCalc() {
            if (!activeCalcContext) return;
            let tw = 0, ws = 0;
            document.querySelectorAll('.subcalc-row').forEach(r => {
                const g = parseFloat(r.querySelector('.sub-grade').value) || 0, w = parseFloat(r.querySelector('.sub-weight').value) || 0;
                if (w > 0) { tw += w; ws += (g * w); }
            });
            const { index, type } = activeCalcContext;
            if (type === 'work') { courses[index].work = (ws/tw) || 0; courses[index].weights.work = tw; }
            else { courses[index].quiz = (ws/tw) || 0; courses[index].weights.quiz = tw; }
            saveData(); renderAll(); calculateAll(); closeSubCalc();
        }

        // --- Render Helpers ---
        function updateFilterOptions() {
            const s = document.getElementById('scopeFilter'), ms = courses.length > 0 ? Math.max(...courses.map(c => c.semester)) : 1;
            let h = '<option value="all">×›×œ ×”×ª×•××¨</option>';
            for (let i = 1; i <= Math.ceil(ms / 2); i++) h += `<option value="year_${i}">×©× ×” ${['×','×‘','×’','×“'][i-1] || i}</option>`;
            h += `<option value="sem_${ms}">×¡××¡×˜×¨ ××—×¨×•×Ÿ (${ms})</option>`;
            s.innerHTML = h;
        }
        function shouldShowInChart(c) {
            const f = document.getElementById('scopeFilter').value;
            if (f === 'all') return true;
            if (f.startsWith('sem_')) return c.semester === parseInt(f.split('_')[1]);
            if (f.startsWith('year_')) { const y = parseInt(f.split('_')[1]); return c.semester >= y*2-1 && c.semester <= y*2; }
            return true;
        }
        function refreshSingleCard(i) {
            const c = courses[i]; if(c.isBinary) return;
            const f = calculateCourseFinal(c);
            const fe = document.getElementById(`final_${i}`); if(fe) { fe.innerText = f; fe.className = `text-3xl font-black ${getGradeColor(f)}`; }
            const ee = document.getElementById(`examVal_${i}`); if(ee) ee.innerText = c.exam;
        }
        function saveData() { localStorage.setItem('harelGradesV11_2', JSON.stringify(courses)); }
        function startNewSemester() { const ms = courses.length > 0 ? Math.max(...courses.map(c => c.semester)) : 0; courses.push({ id: Date.now(), name: '×§×•×¨×¡ ×¨××©×•×Ÿ', semester: ms+1, credits: 3, work: 100, quiz: 0, weights: { work: 10, quiz: 0 }, exam: 60, isBinary: false }); collapsedSemesters[ms+1] = false; saveData(); updateFilterOptions(); renderAll(); calculateAll(); }
        function addNewCourse() { const ms = courses.length > 0 ? Math.max(...courses.map(c => c.semester)) : 1; courses.push({ id: Date.now(), name: '×§×•×¨×¡ ×—×“×©', semester: ms, credits: 3, work: 100, quiz: 0, weights: { work: 10, quiz: 0 }, exam: 60, isBinary: false }); collapsedSemesters[ms] = false; saveData(); updateFilterOptions(); renderAll(); calculateAll(); }
        function removeCourse(i) { if(confirm("×œ××—×•×§?")) { courses.splice(i,1); saveData(); renderAll(); calculateAll(); } }
        function resetDefaults() { if(confirm("×œ××¤×¡?")) { courses = JSON.parse(JSON.stringify(defaultData)); saveData(); renderAll(); calculateAll(); } }
        function exportData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(courses, null, 2)], { type: "application/json" })); a.download = `Grades_Backup.json`; a.click(); }
        function triggerImport() { document.getElementById('importFile').click(); }
        function importData(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => { try { const d = JSON.parse(e.target.result); if(Array.isArray(d)) { courses = d; saveData(); renderAll(); calculateAll(); } } catch(err){alert('×©×’×™××”')} }; r.readAsText(f); }

        function renderAll() {
            renderTable();
            const w = document.getElementById('semesterWrapper'); w.innerHTML = '';
            const sems = [...new Set(courses.map(c => c.semester))].sort((a,b) => a-b);
            sems.forEach(s => {
                w.innerHTML += `<div class="bg-white dark:bg-dark-card rounded-2xl shadow-sm border border-slate-100 dark:border-dark-border overflow-hidden"><div class="p-4 bg-slate-50 dark:bg-slate-800/50 flex items-center justify-between cursor-pointer" onclick="document.getElementById('semContainer_${s}').classList.toggle('hidden-content'); document.getElementById('semIcon_${s}').classList.toggle('rotate-180')"><div class="flex items-center gap-3"><i id="semIcon_${s}" class="fas fa-chevron-down text-slate-400 transition-transform"></i><h2 class="text-lg font-black text-slate-700 dark:text-slate-200">×¡××¡×˜×¨ ${s}</h2></div><div class="bg-white dark:bg-slate-700 px-3 py-1 rounded-full border border-slate-200 dark:border-slate-600 shadow-sm"><span id="semAvg_${s}" class="text-lg font-bold text-blue-600">0.00</span></div></div><div id="semContainer_${s}" class="p-4 space-y-4 border-t border-slate-100 dark:border-slate-700/50"></div></div>`;
                courses.forEach((c, i) => {
                    if (c.semester !== s) return;
                    const final = calculateCourseFinal(c);
                    let badgeHtml = '';
                    if (!c.isBinary && (c.workMagen || c.quizMagen)) {
                        if (c.workMagen) badgeHtml += `<span class="magen-badge text-[9px] ${c.work < c.exam ? 'bg-slate-100 text-slate-500' : 'bg-green-100 text-green-600'} px-2 py-0.5 rounded border border-slate-200 ml-1">×¢×‘' ${c.work < c.exam ? 'ğŸ›¡ï¸ ×”×•×©××˜' : 'âœ… × ×—×©×‘'}</span>`;
                        if (c.quizMagen) badgeHtml += `<span class="magen-badge text-[9px] ${c.quiz < c.exam ? 'bg-slate-100 text-slate-500' : 'bg-green-100 text-green-600'} px-2 py-0.5 rounded border border-slate-200 ml-1">×‘×—×Ÿ ${c.quiz < c.exam ? 'ğŸ›¡ï¸ ×”×•×©××˜' : 'âœ… × ×—×©×‘'}</span>`;
                    }
                    document.getElementById(`semContainer_${s}`).innerHTML += `<div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 flex flex-col sm:flex-row items-center gap-4 hover:border-blue-300 transition-colors group"><div class="flex-1 w-full"><div class="flex justify-between items-center mb-2"><div class="flex items-center flex-wrap gap-1"><h3 class="font-bold text-slate-700 dark:text-slate-200 text-lg">${c.name}</h3>${badgeHtml}</div><span class="text-[10px] text-slate-500 bg-slate-100 dark:bg-slate-900 px-2 py-1 rounded">${c.credits} × ×§"×–</span></div>${c.isBinary ? '<div class="text-green-500 font-bold text-xl"><i class="fas fa-check-circle"></i> ×¢×•×‘×¨</div>' : `<div class="flex items-center gap-3"><div class="flex flex-col items-center w-10"><span class="text-sm font-bold text-blue-600" id="examVal_${i}">${c.exam}</span><span class="text-[9px] text-slate-400">××‘×—×Ÿ</span></div><div class="flex-1 pt-1"><input type="range" value="${c.exam}" oninput="updateData(${i}, 'exam', this.value)" class="accent-blue-600"></div></div>`}</div>${c.isBinary ? '' : `<div class="text-center w-full sm:w-20 sm:pl-4 sm:border-r border-slate-100 dark:border-slate-700"><div class="text-[10px] text-slate-400 font-bold">×¡×•×¤×™</div><div id="final_${i}" class="text-3xl font-black ${getGradeColor(final)}">${final}</div></div>`}</div>`;
                });
            });
        }

        function renderTable() {
            const tb = document.getElementById('settingsTableBody'); tb.innerHTML = '';
            const sems = [...new Set(courses.map(c => c.semester))].sort((a,b) => a-b);
            sems.forEach(s => {
                const isc = collapsedSemesters[s];
                tb.innerHTML += `<tr class="bg-slate-100 dark:bg-slate-700 cursor-pointer font-bold" onclick="collapsedSemesters[${s}]=!collapsedSemesters[${s}]; renderTable();"><td colspan="9" class="p-1.5 pr-4 text-xs"><i class="fas fa-chevron-up text-[8px] transition-transform ${isc?'rotate-180':''}"></i> ×¡××¡×˜×¨ ${s}</td></tr>`;
                if (!isc) {
                    courses.forEach((c, i) => {
                        if (c.semester !== s) return;
                        const bin = c.isBinary;
                        tb.innerHTML += `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors border-b border-slate-100 dark:border-slate-700"><td class="p-1"><input type="text" value="${c.name}" onchange="updateData(${i}, 'name', this.value)" class="input-minimal text-right w-20"></td><td class="p-1 text-center"><input type="checkbox" onchange="updateData(${i}, 'isBinary')" ${bin ? 'checked' : ''} class="w-3 h-3 cursor-pointer"></td><td class="p-1"><input type="number" value="${c.semester}" onchange="updateData(${i}, 'semester', this.value)" class="input-minimal w-10 text-center"></td><td class="p-1"><input type="number" value="${c.credits}" onchange="updateData(${i}, 'credits', this.value)" class="input-minimal w-10 text-center"></td><td class="p-1 ${bin?'opacity-20 pointer-events-none':''}"><div class="flex items-center gap-1 justify-center"><input type="number" value="${Math.round(c.work)}" onchange="updateData(${i}, 'work', this.value)" class="input-minimal text-blue-600 w-10"> <button onclick="openSubCalc(${i}, 'work')" class="text-[9px] text-slate-400 hover:text-blue-500"><i class="fas fa-calculator"></i></button></div></td><td class="p-1 ${bin?'opacity-20 pointer-events-none':''}"><div class="flex items-center gap-1 justify-center"><input type="number" value="${Math.round(c.quiz)}" onchange="updateData(${i}, 'quiz', this.value)" class="input-minimal text-blue-600 w-10"> <button onclick="openSubCalc(${i}, 'quiz')" class="text-[9px] text-slate-400 hover:text-blue-500"><i class="fas fa-calculator"></i></button></div></td><td class="p-1 ${bin?'opacity-20 pointer-events-none':''}"><div class="flex items-center gap-0.5 justify-center"><input type="number" value="${c.weights.work}" onchange="updateData(${i}, 'weights', this.value, 'work')" class="input-minimal text-orange-600 w-8"> <button onclick="toggleMagen(${i}, 'work')" class="text-[9px] ${c.workMagen?'text-green-500':'text-slate-300'}"><i class="fas fa-shield-alt"></i></button></div></td><td class="p-1 ${bin?'opacity-20 pointer-events-none':''}"><div class="flex items-center gap-0.5 justify-center"><input type="number" value="${c.weights.quiz}" onchange="updateData(${i}, 'weights', this.value, 'quiz')" class="input-minimal text-orange-600 w-8"> <button onclick="toggleMagen(${i}, 'quiz')" class="text-[9px] ${c.quizMagen?'text-green-500':'text-slate-300'}"><i class="fas fa-shield-alt"></i></button></div></td><td class="p-1 text-center"><button onclick="removeCourse(${i})" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-times"></i></button></td></tr>`;
                    });
                }
            });
        }

        init();
    </script>
</body>
</html>